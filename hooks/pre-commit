#!/bin/bash
# Pre-commit hook to prevent runtime files from being committed
# and ensure code quality

set -e

echo "Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for runtime files in staging
echo -n "Checking for runtime files... "
RUNTIME_FILES=$(git diff --cached --name-only | grep -E '^(data/|logs/|workspace/|.*\.db$)' || true)

if [ -n "$RUNTIME_FILES" ]; then
    echo -e "${RED}FAILED${NC}"
    echo ""
    echo -e "${RED}ERROR: Attempting to commit runtime files:${NC}"
    echo "$RUNTIME_FILES" | sed 's/^/  /'
    echo ""
    echo "These files should be in ~/obra-runtime/, not the repository."
    echo "Run: git reset HEAD <file> to unstage"
    echo ""
    exit 1
fi
echo -e "${GREEN}OK${NC}"

# Check that integration tests pass (if they exist)
if [ -f "tests/test_cli_integration.py" ]; then
    echo -n "Running integration tests... "

    # Activate venv if it exists
    if [ -f "venv/bin/activate" ]; then
        source venv/bin/activate
    fi

    # Run tests with timeout
    if timeout 30 python -m pytest tests/test_cli_integration.py -v -x --tb=line > /tmp/pre-commit-test.log 2>&1; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAILED${NC}"
        echo ""
        echo -e "${RED}Integration tests failed. See details:${NC}"
        tail -20 /tmp/pre-commit-test.log
        echo ""
        echo "Fix the tests or run: git commit --no-verify (not recommended)"
        exit 1
    fi
fi

# Check for common bugs
echo -n "Checking for common bugs... "
BUGS=0

# Check for Config() instead of Config.load()
if git diff --cached --name-only | grep -q '\.py$'; then
    if git diff --cached | grep -E '^\+.*Config\(\)' > /dev/null 2>&1; then
        echo -e "${YELLOW}WARNING${NC}"
        echo -e "${YELLOW}Found Config() - should this be Config.load()?${NC}"
        BUGS=1
    fi

    # Check for wrong model attributes
    if git diff --cached | grep -E '^\+.*(project\.name|\.working_dir[^e])' > /dev/null 2>&1; then
        if [ $BUGS -eq 0 ]; then
            echo -e "${YELLOW}WARNING${NC}"
        fi
        echo -e "${YELLOW}Found .name or .working_dir - use .project_name and .working_directory${NC}"
        BUGS=1
    fi
fi

if [ $BUGS -eq 0 ]; then
    echo -e "${GREEN}OK${NC}"
fi

echo ""
echo -e "${GREEN}âœ“ Pre-commit checks passed${NC}"
