{
  "bug_id": "nl_task_type_parameter_missing",
  "date": "2025-11-13",
  "severity": "high",
  "status": "fixed",
  "component": "state_manager",
  "related_adrs": ["ADR-013", "ADR-014", "ADR-017"],

  "problem": {
    "summary": "StateManager.list_tasks() missing task_type parameter causing NL hierarchical queries to fail",
    "user_input": "list the plans (epics, stories, tasks, etc) in project #1",
    "expected_behavior": "Show hierarchical structure with epics, stories, and tasks",
    "actual_behavior": "TypeError: StateManager.list_tasks() got an unexpected keyword argument 'task_type'",
    "error_message": "StateManager.list_tasks() got an unexpected keyword argument 'task_type'"
  },

  "root_causes": [
    {
      "issue_id": 1,
      "name": "api_mismatch",
      "location": "src/core/state.py:644-685",
      "description": "NLQueryHelper calls list_tasks(task_type=...) but parameter doesn't exist in method signature",
      "current_behavior": "Method signature only accepts project_id, status, limit parameters",
      "impact": "All NL queries requiring task type filtering fail with TypeError"
    },
    {
      "issue_id": 2,
      "name": "inconsistent_api",
      "location": "src/core/state.py",
      "description": "Other methods (get_epic_stories, get_story_tasks) filter by task_type, but list_tasks() doesn't",
      "current_behavior": "API inconsistency across StateManager methods",
      "impact": "Confusing API that doesn't follow its own patterns"
    }
  ],

  "solution": {
    "strategy": "Add task_type parameter to StateManager.list_tasks() following existing filter pattern",
    "fixes": [
      {
        "fix_id": 1,
        "name": "add_task_type_parameter",
        "file": "src/core/state.py",
        "lines": "644-691",
        "priority": "critical",
        "changes": [
          "Add task_type: Optional[TaskType] = None parameter to method signature",
          "Add filtering logic: if task_type is not None: query = query.filter(Task.task_type == task_type)",
          "Update docstring with new parameter and example",
          "Maintain backward compatibility (optional parameter)"
        ],
        "lines_changed": 4,
        "breaking_changes": false
      }
    ]
  },

  "implementation_tasks": [
    {
      "step": 1,
      "name": "analysis",
      "status": "completed",
      "tasks": [
        "Analyzed error traceback",
        "Identified API mismatch between NLQueryHelper and StateManager",
        "Verified NLQueryHelper calls were correct",
        "Confirmed StateManager was missing parameter"
      ]
    },
    {
      "step": 2,
      "name": "modify_state_manager",
      "status": "completed",
      "file": "src/core/state.py",
      "lines": "644-691",
      "tasks": [
        "Added task_type parameter to method signature",
        "Added filtering logic in query chain",
        "Updated docstring",
        "Added example usage"
      ]
    },
    {
      "step": 3,
      "name": "write_unit_tests",
      "status": "completed",
      "file": "tests/test_state_manager_task_operations.py",
      "lines": "169-323",
      "tasks": [
        "Created TestTaskTypeFiltering class",
        "Added test_filter_by_epic",
        "Added test_filter_by_story",
        "Added test_filter_by_task",
        "Added test_filter_by_subtask",
        "Added test_no_filter_returns_all_types",
        "Added test_filter_with_limit",
        "Added test_filter_with_status"
      ]
    },
    {
      "step": 4,
      "name": "verify_no_regressions",
      "status": "completed",
      "tasks": [
        "Ran all 17 tests in test_state_manager_task_operations.py",
        "Verified all tests passing",
        "Ran NL query tests",
        "Confirmed no breaking changes"
      ]
    },
    {
      "step": 5,
      "name": "integration_testing",
      "status": "completed",
      "tasks": [
        "Created manual test script",
        "Verified StateManager.list_tasks(task_type=...) works",
        "Verified NLQueryHelper._query_simple() works",
        "Verified NLQueryHelper._query_hierarchical() works",
        "Tested original failing command"
      ]
    }
  ],

  "testing": {
    "unit_tests": {
      "count": 7,
      "file": "tests/test_state_manager_task_operations.py",
      "class": "TestTaskTypeFiltering",
      "status": "all_passing",
      "coverage": "100%"
    },
    "integration_tests": {
      "count": 1,
      "description": "Manual verification script",
      "status": "passed"
    },
    "regression_tests": {
      "count": 17,
      "file": "tests/test_state_manager_task_operations.py",
      "status": "all_passing"
    },
    "total_tests": 25,
    "total_passed": 25
  },

  "risk_assessment": {
    "risk_level": "low",
    "reasons": [
      "New optional parameter (zero breaking changes)",
      "Follows existing pattern (status parameter)",
      "Simple implementation (3 lines of code)",
      "Comprehensive test coverage (7 new tests)",
      "All existing tests still passing"
    ],
    "backward_compatibility": {
      "preserved": true,
      "details": [
        "task_type is optional (defaults to None)",
        "Existing calls without task_type work unchanged",
        "No changes to return type or behavior when parameter omitted"
      ]
    },
    "rollback_plan": {
      "method": "git revert",
      "fallback": "Remove task_type parameter and filtering logic",
      "database_changes": false
    }
  },

  "effort_estimate": {
    "code_changes_minutes": 5,
    "unit_tests_minutes": 15,
    "verification_minutes": 10,
    "documentation_minutes": 10,
    "total_minutes": 40
  },

  "success_metrics": {
    "before_fix": [
      "NL hierarchical queries fail with TypeError",
      "NL simple queries for task types fail",
      "Inconsistent API across StateManager methods"
    ],
    "after_fix": [
      "NL hierarchical queries work correctly",
      "NL simple queries for task types work",
      "Consistent API with other StateManager methods",
      "Zero breaking changes",
      "All 17 tests passing"
    ]
  },

  "code_locations": [
    {
      "file": "src/core/state.py",
      "lines": "644-691",
      "method": "list_tasks",
      "description": "Added task_type parameter and filtering logic"
    },
    {
      "file": "src/nl/nl_query_helper.py",
      "lines": "278, 315",
      "description": "Existing calls to list_tasks(task_type=...) now work"
    },
    {
      "file": "tests/test_state_manager_task_operations.py",
      "lines": "169-323",
      "class": "TestTaskTypeFiltering",
      "description": "7 new tests for task_type filtering"
    }
  ],

  "files_modified": {
    "src/core/state.py": {
      "lines_added": 4,
      "lines_modified": 0,
      "lines_deleted": 0,
      "description": "Added task_type parameter and filtering"
    },
    "tests/test_state_manager_task_operations.py": {
      "lines_added": 154,
      "lines_modified": 0,
      "lines_deleted": 0,
      "description": "Added TestTaskTypeFiltering class with 7 tests"
    },
    "CHANGELOG.md": {
      "lines_added": 13,
      "lines_modified": 0,
      "lines_deleted": 0,
      "description": "Added bug fix entry under [Unreleased]"
    }
  },

  "references": {
    "adrs": [
      "docs/decisions/ADR-013-adopt-agile-work-hierarchy.md",
      "docs/decisions/ADR-014-natural-language-command-interface.md",
      "docs/decisions/ADR-017-unified-execution-architecture.md"
    ],
    "guides": [
      "docs/guides/NL_COMMAND_GUIDE.md",
      "docs/guides/AGILE_WORKFLOW_GUIDE.md"
    ],
    "related_bugs": []
  }
}
