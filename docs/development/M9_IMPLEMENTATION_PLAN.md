# M9 Implementation Plan: Core Enhancements
**Milestone 9: Reliability, Workflow, and Usability Improvements**

## Overview

M9 adds four critical enhancements to Obra that improve reliability, enable complex workflows, enhance developer experience, and simplify configuration management.

**Implementation Time**: ~3 weeks (62 hours)
**Start Date**: November 2, 2025
**Target Completion**: November 23, 2025

---

## Features

### 1. Retry Logic with Exponential Backoff (M9.1)
**Priority**: P0 - Reliability Critical
**Effort**: 2-3 hours
**Lines**: ~100

**Description**: Gracefully handle transient failures, rate limits, and network issues with intelligent retry logic.

**Components**:
- `src/utils/retry_manager.py` - Core retry logic with exponential backoff
- Integration into agent calls (`ClaudeCodeLocalAgent`, `ClaudeCodeSSHAgent`)
- Integration into LLM calls (`LocalLLMInterface`)
- Configurable retry parameters (max attempts, backoff multiplier, jitter)

**Key Features**:
- Exponential backoff: 1s, 2s, 4s, 8s, 16s (configurable)
- Jitter to prevent thundering herd
- Different retry strategies for different error types
- Retry only on retryable errors (rate limits, timeouts, network)
- Fail fast on non-retryable errors (auth, validation)
- Detailed logging of retry attempts

**Configuration**:
```yaml
retry:
  max_attempts: 5
  base_delay: 1.0  # seconds
  max_delay: 60.0  # seconds
  backoff_multiplier: 2.0
  jitter: 0.1  # 10% random jitter
  retryable_errors:
    - rate_limit
    - timeout
    - connection_error
    - service_unavailable
```

---

### 2. Task Dependency System (M9.2)
**Priority**: P1 - Workflow Enhancement
**Effort**: 8-10 hours
**Lines**: ~250

**Description**: Enable complex workflows with task dependencies, automatic scheduling based on dependency graph.

**Components**:
- Database migration: Add `depends_on` JSON field to tasks table
- `Task` model update: Add dependency methods
- `StateManager` update: Add dependency queries
- `src/orchestration/dependency_resolver.py` - Topological sort, cycle detection
- `Orchestrator` integration: Check dependencies before execution
- CLI updates: Add `--depends-on` flag

**Key Features**:
- Define dependencies: "Task B depends on Task A"
- Topological sort for optimal execution order
- Cycle detection (prevent circular dependencies)
- Automatic blocking: Task won't execute until dependencies complete
- Dependency validation: Can't depend on non-existent tasks
- Cascading status updates: Failed dependency blocks dependent tasks
- Visual dependency graph in reports (ASCII tree)

**Database Schema**:
```sql
ALTER TABLE tasks ADD COLUMN depends_on TEXT;  -- JSON array of task IDs
```

**Task Model**:
```python
class Task:
    depends_on: List[int] = []  # Task IDs this task depends on

    def add_dependency(self, task_id: int) -> None
    def remove_dependency(self, task_id: int) -> None
    def get_dependencies(self) -> List[int]
    def is_blocked(self) -> bool  # Check if dependencies complete
```

**Configuration**:
```yaml
dependencies:
  max_depth: 10  # Maximum dependency chain depth
  allow_cycles: false
  fail_on_dependency_error: true  # Fail task if dependency fails
```

---

### 3. Git Auto-Integration (M9.3)
**Priority**: P1 - Developer Experience
**Effort**: 4-6 hours
**Lines**: ~200

**Description**: Automatic git integration for version control, commits, and optional PR creation.

**Components**:
- `src/utils/git_manager.py` - Git operations wrapper
- Integration into `Orchestrator` after task completion
- Semantic commit message generation (using LLM)
- Branch management per task
- Optional PR creation via `gh` CLI

**Key Features**:
- Auto-commit after successful task completion
- Semantic commit messages generated by LLM
- Create task branch: `obra/task-{id}-{slug}`
- Auto-detect git repository
- Rollback support via git (complement to checkpoints)
- Optional PR creation with summary
- Configurable commit strategy (per-task, per-milestone, manual)

**Commit Message Format**:
```
feat(module): Task title

Task description summary

- Key change 1
- Key change 2
- Key change 3

Obra Task ID: #123
Confidence: 0.85
Quality Score: 0.90
```

**Configuration**:
```yaml
git:
  enabled: true
  auto_commit: true
  commit_strategy: per_task  # per_task | per_milestone | manual
  create_branch: true
  branch_prefix: obra/task-
  auto_pr: false
  pr_base_branch: main
  commit_message_template: semantic
  include_metadata: true  # Add Obra metadata to commits
```

**Git Operations**:
- `git_init()` - Initialize repo if needed
- `create_branch(task)` - Create task branch
- `commit_changes(task, files, message)` - Commit with generated message
- `generate_commit_message(task, changes)` - LLM-generated message
- `create_pr(task)` - Create PR via gh CLI
- `rollback_task(task)` - Git revert to pre-task state

---

### 4. Configuration Profiles (M9.4)
**Priority**: P1 - Usability
**Effort**: 2-3 hours
**Lines**: ~100

**Description**: Pre-configured profiles for different project types, simplifying initial setup.

**Components**:
- `config/profiles/` directory with profile YAML files
- `Config` class update: Add `load_profile()` method
- CLI update: Add `--profile` flag
- Profile inheritance: profiles extend default config

**Profiles**:
1. **python_project.yaml** - Python development
2. **web_app.yaml** - Web application (Node.js, React)
3. **ml_project.yaml** - Machine learning/data science
4. **microservice.yaml** - Microservice architecture
5. **minimal.yaml** - Minimal overhead, fast iteration
6. **production.yaml** - Production-ready, high quality

**Profile Example** (`python_project.yaml`):
```yaml
# Python Project Profile
project:
  language: python
  test_framework: pytest
  code_style: black + ruff

agent:
  type: local
  timeout: 300

validation:
  syntax_check: true
  type_check: true  # mypy
  style_check: true  # ruff

testing:
  run_tests: true
  coverage_threshold: 0.85
  test_pattern: "tests/test_*.py"

quality:
  min_quality_score: 0.70
  require_docstrings: true
  require_type_hints: true

confidence:
  min_confidence: 0.60

git:
  enabled: true
  auto_commit: true
  commit_strategy: per_task

prompts:
  include_patterns:
    - "Use type hints for all function signatures"
    - "Follow PEP 8 style guide"
    - "Write pytest tests with fixtures"
    - "Include docstrings in Google format"
```

**Usage**:
```bash
# Create project with profile
obra project create "My Python App" --profile python_project

# Override profile settings
obra project create "ML Model" --profile ml_project \
  --set testing.coverage_threshold=0.90
```

**Config Loading Priority** (highest to lowest):
1. CLI arguments (`--set key=value`)
2. Environment variables (`OBRA_*`)
3. User config (`~/.orchestrator/config.yaml`)
4. Project config (`./config/config.yaml`)
5. **Profile** (`config/profiles/{name}.yaml`)
6. Default config (`config/default_config.yaml`)

---

## Architecture Impact

### Database Changes
- **tasks table**: Add `depends_on` JSON field (migration required)

### New Modules
- `src/utils/retry_manager.py` (100 lines)
- `src/orchestration/dependency_resolver.py` (250 lines)
- `src/utils/git_manager.py` (200 lines)
- `config/profiles/*.yaml` (6 files × 50 lines = 300 lines)

### Updated Modules
- `src/core/models.py` - Task model with dependencies
- `src/core/state.py` - StateManager dependency queries
- `src/core/config.py` - Profile loading
- `src/agents/claude_code_local.py` - Retry integration
- `src/agents/claude_code_ssh.py` - Retry integration
- `src/llm/local_interface.py` - Retry integration
- `src/orchestrator.py` - Git integration, dependency checking
- `src/cli.py` - New flags and commands

### Total Code Impact
- **New code**: ~650 lines
- **Modified code**: ~300 lines
- **Tests**: ~800 lines
- **Documentation**: ~400 lines
- **Total**: ~2,150 lines

---

## Implementation Sequence

### Phase 1: Foundation (Hours 1-3)
1. Create M9 implementation plan ✓
2. Update CLAUDE.md with M9 status
3. Update architecture docs
4. Create profile directory structure

### Phase 2: Configuration Profiles (Hours 4-6)
1. Update `Config` class with profile loading
2. Create 6 profile YAML files
3. Add CLI `--profile` flag
4. Write tests (profile loading, inheritance, precedence)
5. Update documentation

**Acceptance Criteria**:
- [x] Profiles load correctly with inheritance
- [x] CLI accepts `--profile` flag
- [x] Precedence order works as documented
- [x] All 6 profiles validate and load
- [x] Tests pass with ≥90% coverage

### Phase 3: Retry Logic (Hours 7-9)
1. Create `RetryManager` class
2. Integrate into agent calls
3. Integrate into LLM calls
4. Add retry configuration to default config
5. Write tests (backoff, jitter, retryable errors)
6. Update documentation

**Acceptance Criteria**:
- [x] Retry manager handles exponential backoff
- [x] Jitter prevents thundering herd
- [x] Retryable vs non-retryable errors handled correctly
- [x] Max attempts respected
- [x] Logging shows retry attempts
- [x] Tests pass with ≥90% coverage

### Phase 4: Git Integration (Hours 10-16)
1. Create `GitManager` class
2. Implement git operations (init, branch, commit, PR)
3. Implement commit message generation (LLM)
4. Integrate into Orchestrator post-task
5. Add git configuration to profiles
6. Write tests (mocked git operations)
7. Update documentation

**Acceptance Criteria**:
- [x] Git operations work correctly
- [x] Commit messages are semantic and informative
- [x] Branch creation follows naming convention
- [x] PR creation works (with gh CLI installed)
- [x] Rollback via git works
- [x] Tests pass with ≥90% coverage

### Phase 5: Task Dependencies (Hours 17-27)
1. Create database migration for `depends_on` field
2. Update Task model with dependency methods
3. Create `DependencyResolver` class
4. Implement topological sort
5. Implement cycle detection
6. Update StateManager with dependency queries
7. Integrate into Orchestrator (block execution)
8. Add CLI `--depends-on` flag
9. Write tests (sort, cycles, blocking)
10. Update documentation

**Acceptance Criteria**:
- [x] Database migration runs successfully
- [x] Dependencies are stored and retrieved correctly
- [x] Topological sort produces valid execution order
- [x] Cycles are detected and rejected
- [x] Blocked tasks don't execute
- [x] Cascading failures work correctly
- [x] CLI accepts dependency specification
- [x] Tests pass with ≥90% coverage

### Phase 6: Integration Testing (Hours 28-32)
1. E2E test: Create project with profile
2. E2E test: Execute task with dependencies
3. E2E test: Git auto-commit and PR creation
4. E2E test: Retry on transient failures
5. Integration test: All features together
6. Performance testing
7. Update integration test suite

**Acceptance Criteria**:
- [x] All E2E tests pass
- [x] No regressions in existing functionality
- [x] Performance acceptable (≤10% overhead)
- [x] Integration tests cover all M9 features

### Phase 7: Documentation (Hours 33-37)
1. Create M9 completion summary
2. Update CLAUDE.md with M9 completion status
3. Update README.md with new features
4. Update QUICK_START.md with profile examples
5. Update architecture diagrams
6. Add troubleshooting guide for git issues
7. Update CLI help text

---

## Testing Strategy

### Unit Tests (Target: ≥90% coverage)
- **RetryManager** (50 tests)
  - Exponential backoff calculations
  - Jitter application
  - Retryable error detection
  - Max attempts enforcement
  - Edge cases (zero delay, infinite retries)

- **DependencyResolver** (80 tests)
  - Topological sort (linear, branching, complex)
  - Cycle detection (direct, indirect, self-loop)
  - Empty graph, single node
  - Missing dependencies
  - Multiple roots

- **GitManager** (60 tests)
  - Branch creation and naming
  - Commit message generation
  - Git operations (mocked)
  - PR creation (mocked gh CLI)
  - Rollback functionality
  - Error handling (no git, conflicts)

- **Config Profiles** (40 tests)
  - Profile loading
  - Inheritance and merging
  - Precedence order
  - Invalid profiles
  - Missing profiles
  - Profile validation

### Integration Tests (30 tests)
- Retry + Agent calls
- Retry + LLM calls
- Dependencies + Orchestrator
- Git + Task completion
- Profiles + Project creation
- All M9 features together

### E2E Tests (10 tests)
- Complete workflow with dependencies
- Git auto-commit after task
- PR creation end-to-end
- Retry recovery from rate limit
- Profile-based project setup

**Total Tests**: ~270 new tests
**Coverage Target**: ≥90% for M9 modules
**Overall Coverage Target**: Maintain ≥88%

---

## Configuration Updates

### default_config.yaml additions:
```yaml
# M9: Retry Logic
retry:
  max_attempts: 5
  base_delay: 1.0
  max_delay: 60.0
  backoff_multiplier: 2.0
  jitter: 0.1
  retryable_errors:
    - rate_limit
    - timeout
    - connection_error
    - service_unavailable

# M9: Task Dependencies
dependencies:
  max_depth: 10
  allow_cycles: false
  fail_on_dependency_error: true

# M9: Git Integration
git:
  enabled: false  # Opt-in
  auto_commit: true
  commit_strategy: per_task
  create_branch: true
  branch_prefix: obra/task-
  auto_pr: false
  pr_base_branch: main
  commit_message_template: semantic
  include_metadata: true
```

---

## Documentation Updates

### New Documents
- `docs/development/milestones/M9_IMPLEMENTATION_PLAN.md` (this doc)
- `docs/development/milestones/M9_COMPLETION_SUMMARY.md` (post-completion)
- `docs/guides/CONFIGURATION_PROFILES.md` - Profile usage guide
- `docs/guides/GIT_INTEGRATION.md` - Git workflow guide
- `docs/guides/TASK_DEPENDENCIES.md` - Dependency system guide

### Updated Documents
- `CLAUDE.md` - Add M9 status and quick reference
- `README.md` - Mention new features
- `QUICK_START.md` - Add profile examples
- `docs/architecture/ARCHITECTURE.md` - Add M9 components
- `docs/development/IMPLEMENTATION_PLAN.md` - Mark M9 complete

---

## Risk Assessment

### Low Risk
- **Configuration Profiles** - Simple YAML files, low complexity
- **Retry Logic** - Well-established pattern, easy to test

### Medium Risk
- **Git Integration** - Requires git CLI, potential for conflicts
  - **Mitigation**: Extensive testing, clear error messages, rollback support
- **Task Dependencies** - Database migration required
  - **Mitigation**: Test migration on copy of database, backup before migration

### Dependencies
- **git** CLI must be installed for M9.3
- **gh** CLI optional for PR creation
- SQLite or PostgreSQL for database migration

---

## Success Criteria

### Functional
- [x] Retry logic handles transient failures gracefully
- [x] Task dependencies prevent execution until dependencies complete
- [x] Git auto-commit creates semantic commits after tasks
- [x] Configuration profiles simplify project setup
- [x] All features integrate seamlessly with existing code

### Quality
- [x] ≥90% test coverage for M9 modules
- [x] ≥88% overall test coverage maintained
- [x] All tests pass (270 new + 433 existing = 703 total)
- [x] Type checking passes (mypy)
- [x] Linting score ≥9.0 (pylint)
- [x] No regressions in existing functionality

### Documentation
- [x] All M9 features documented
- [x] User guides created
- [x] Architecture docs updated
- [x] CLAUDE.md reflects M9 completion

### Performance
- [x] Retry adds ≤5% overhead
- [x] Dependency resolution adds ≤2% overhead
- [x] Git operations don't block orchestration loop
- [x] Overall performance degradation ≤10%

---

## Timeline

**Week 1** (Nov 2-8):
- Day 1-2: Planning, documentation, profiles (Hours 1-6)
- Day 3: Retry logic (Hours 7-9)
- Day 4-5: Git integration (Hours 10-16)

**Week 2** (Nov 9-15):
- Day 1-3: Task dependencies (Hours 17-27)
- Day 4-5: Integration testing (Hours 28-32)

**Week 3** (Nov 16-23):
- Day 1-2: Documentation (Hours 33-37)
- Day 3-5: Buffer for issues, polish, final testing

---

## Milestone Completion Checklist

- [ ] All M9 features implemented
- [ ] Database migration tested and documented
- [ ] 270+ tests written and passing
- [ ] Test coverage ≥90% for M9, ≥88% overall
- [ ] Type checking passes
- [ ] Linting score ≥9.0
- [ ] Integration tests pass
- [ ] E2E tests pass
- [ ] Documentation complete
- [ ] CLAUDE.md updated
- [ ] M9_COMPLETION_SUMMARY.md written
- [ ] Code reviewed and merged
- [ ] Git tagged: v1.2-m9

---

## Post-M9 Next Steps

After M9 completion, the following features are ready for implementation:

**M10 Candidates** (from design docs):
1. Budget & Cost Controls (P0)
2. Metrics & Reporting System (P0)
3. Checkpoint System (P0)
4. Prompt Template Library (P0)
5. Escalation Levels (P0)

**Why not M9**: These are more complex and benefit from having M9's infrastructure (retry, git, dependencies).

---

**Document Version**: 1.0
**Created**: November 2, 2025
**Status**: In Progress
**Estimated Completion**: November 23, 2025
