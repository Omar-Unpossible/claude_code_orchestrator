{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "meta": {
    "epic_id": "QW-001",
    "created_at": "2025-11-11T00:00:00Z",
    "updated_at": "2025-11-11T00:00:00Z",
    "prompt_version": "2.2",
    "agent_version": "claude-sonnet-4-20250514",
    "approved_by": "pending",
    "approved_at": null
  },
  "objective": {
    "summary": "Implement 10 high-ROI quick wins for Obra security, UX, and automation",
    "user_stories": [
      "As a user, I want protection from prompt injection attacks so that my agent behavior cannot be hijacked",
      "As a user, I want PII and secrets automatically redacted from logs so I can safely share debug information",
      "As a user, I want confirmation prompts for destructive git operations so I don't accidentally lose work",
      "As a user, I want specialized templates for bug fixes so I can get better quality fixes faster",
      "As a user, I want specialized templates for refactoring so I can safely improve code without regressions",
      "As a user, I want automatic linting before commits so I never commit broken code",
      "As a user, I want machine-readable logs with correlation IDs so I can easily trace issues",
      "As a user, I want a quick reference guide so I can quickly find common commands"
    ],
    "success_criteria": [
      "All 10 quick wins implemented and tested",
      "Test coverage maintained at ≥90%",
      "Zero breaking changes (backward compatible)",
      "All security metrics achieved (≥95% injection detection, 0 PII leaks)",
      "All quality metrics achieved (40% better bug fix success, 80% template adoption)",
      "All automation metrics achieved (<5s pre-commit time, 50% reduction in broken commits)",
      "User satisfaction ≥4.0/5.0"
    ]
  },
  "constraints": {
    "max_tokens_per_phase": 50000,
    "max_files_per_commit": 15,
    "context_threshold_pct": 70,
    "test_coverage_min_pct": 90,
    "performance_targets": {
      "p95_latency_ms": 100,
      "pre_commit_time_ms": 5000,
      "logging_overhead_pct": 5
    },
    "security": {
      "data_classification": "internal",
      "encryption_required": ["at-rest"],
      "regulatory_requirements": []
    }
  },
  "dependencies": {
    "existing_packages": [
      {
        "name": "pytest",
        "version": "7.4.0",
        "ecosystem": "pip"
      },
      {
        "name": "pylint",
        "version": "2.17.0",
        "ecosystem": "pip"
      },
      {
        "name": "mypy",
        "version": "1.5.0",
        "ecosystem": "pip"
      }
    ],
    "new_packages": [
      {
        "name": "pre-commit",
        "version": "3.5.0",
        "ecosystem": "pip",
        "justification": "Automated pre-commit hooks for code quality (QW-007)",
        "alternatives_considered": [
          "husky (Node.js-specific, not suitable for Python)",
          "custom git hooks (less maintainable)"
        ],
        "security_scan_status": "passed",
        "license": "MIT"
      }
    ],
    "tools_and_resources": [
      {
        "name": "regex",
        "purpose": "Pattern matching for injection detection and PII sanitization",
        "permissions_required": ["read"],
        "configuration": {}
      },
      {
        "name": "sqlite3",
        "purpose": "Database for approval_log table",
        "permissions_required": ["read", "write"],
        "configuration": {
          "database_path": "~/.obra/obra.db"
        }
      }
    ]
  },
  "plan": {
    "phases": [
      {
        "phase_id": "P1",
        "name": "Security Foundation (Week 1)",
        "description": "Implement critical security features: input sanitization, output sanitization, git operation confirmation",
        "estimated_tokens": 15000,
        "estimated_duration_hours": 40,
        "stories": [
          {
            "story_id": "S1.1",
            "description": "QW-001: Input Sanitization Basic Patterns",
            "acceptance_criteria": [
              "InjectionDetector class detects all critical patterns",
              "Sanitizer class supports 3 modes (remove/redact/escape)",
              "Integration with StructuredPromptBuilder blocks malicious prompts",
              "Integration with CommandProcessor blocks suspicious interactive commands",
              "≥95% test coverage for security modules",
              "<1% false positive rate on legitimate tasks"
            ],
            "tasks": [
              {
                "task_id": "T1.1.1",
                "description": "Create src/security module structure",
                "type": "code",
                "estimated_tokens": 1000,
                "dependencies": [],
                "artifacts": [
                  "src/security/__init__.py",
                  "src/security/injection_detector.py",
                  "src/security/sanitizer.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy"
                ]
              },
              {
                "task_id": "T1.1.2",
                "description": "Implement InjectionDetector with critical patterns",
                "type": "code",
                "estimated_tokens": 2000,
                "dependencies": ["T1.1.1"],
                "artifacts": [
                  "src/security/injection_detector.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy",
                  "unit-tests"
                ]
              },
              {
                "task_id": "T1.1.3",
                "description": "Implement Sanitizer with 3 modes",
                "type": "code",
                "estimated_tokens": 1500,
                "dependencies": ["T1.1.1"],
                "artifacts": [
                  "src/security/sanitizer.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy",
                  "unit-tests"
                ]
              },
              {
                "task_id": "T1.1.4",
                "description": "Integrate with StructuredPromptBuilder",
                "type": "code",
                "estimated_tokens": 1000,
                "dependencies": ["T1.1.2", "T1.1.3"],
                "artifacts": [
                  "src/llm/structured_prompt_builder.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy",
                  "integration-tests"
                ]
              },
              {
                "task_id": "T1.1.5",
                "description": "Integrate with CommandProcessor",
                "type": "code",
                "estimated_tokens": 800,
                "dependencies": ["T1.1.2", "T1.1.3"],
                "artifacts": [
                  "src/utils/command_processor.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy",
                  "integration-tests"
                ]
              },
              {
                "task_id": "T1.1.6",
                "description": "Add configuration options for input sanitization",
                "type": "config",
                "estimated_tokens": 500,
                "dependencies": ["T1.1.4", "T1.1.5"],
                "artifacts": [
                  "src/core/config.py",
                  "config/profiles/default.yaml"
                ],
                "validation_rules": [
                  "schema-validation"
                ]
              },
              {
                "task_id": "T1.1.7",
                "description": "Write comprehensive unit tests for injection detector",
                "type": "test",
                "estimated_tokens": 1500,
                "dependencies": ["T1.1.2"],
                "artifacts": [
                  "tests/security/test_injection_detector.py"
                ],
                "validation_rules": [
                  "pytest",
                  "coverage>=95%"
                ]
              },
              {
                "task_id": "T1.1.8",
                "description": "Write comprehensive unit tests for sanitizer",
                "type": "test",
                "estimated_tokens": 1200,
                "dependencies": ["T1.1.3"],
                "artifacts": [
                  "tests/security/test_sanitizer.py"
                ],
                "validation_rules": [
                  "pytest",
                  "coverage>=95%"
                ]
              },
              {
                "task_id": "T1.1.9",
                "description": "Write integration tests for input sanitization",
                "type": "test",
                "estimated_tokens": 1500,
                "dependencies": ["T1.1.4", "T1.1.5"],
                "artifacts": [
                  "tests/integration/test_input_sanitization.py"
                ],
                "validation_rules": [
                  "pytest",
                  "coverage>=90%"
                ]
              },
              {
                "task_id": "T1.1.10",
                "description": "Update documentation for input sanitization",
                "type": "doc",
                "estimated_tokens": 800,
                "dependencies": ["T1.1.6"],
                "artifacts": [
                  "docs/guides/SECURITY.md",
                  "CLAUDE.md"
                ],
                "validation_rules": [
                  "markdown-lint"
                ]
              }
            ]
          },
          {
            "story_id": "S1.2",
            "description": "QW-002: Tool Output Sanitization (PII/Secrets)",
            "acceptance_criteria": [
              "OutputSanitizer detects and redacts all PII patterns (email, SSN, phone)",
              "OutputSanitizer detects and redacts all secret patterns (API keys, passwords, AWS keys)",
              "All logging wrapped with sanitizer",
              "Zero PII/secrets in logs",
              "<0.1% false positive rate",
              "<5% performance overhead"
            ],
            "tasks": [
              {
                "task_id": "T1.2.1",
                "description": "Implement OutputSanitizer with PII/secret patterns",
                "type": "code",
                "estimated_tokens": 2000,
                "dependencies": [],
                "artifacts": [
                  "src/security/output_sanitizer.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy",
                  "unit-tests"
                ]
              },
              {
                "task_id": "T1.2.2",
                "description": "Integrate OutputSanitizer with all logging",
                "type": "code",
                "estimated_tokens": 1500,
                "dependencies": ["T1.2.1"],
                "artifacts": [
                  "src/orchestrator.py",
                  "src/agents/claude_code_local.py",
                  "src/core/state.py"
                ],
                "validation_rules": [
                  "grep-for-unsanitized-logs"
                ]
              },
              {
                "task_id": "T1.2.3",
                "description": "Add configuration for output sanitization",
                "type": "config",
                "estimated_tokens": 400,
                "dependencies": ["T1.2.1"],
                "artifacts": [
                  "src/core/config.py"
                ],
                "validation_rules": [
                  "schema-validation"
                ]
              },
              {
                "task_id": "T1.2.4",
                "description": "Write unit tests for OutputSanitizer",
                "type": "test",
                "estimated_tokens": 1500,
                "dependencies": ["T1.2.1"],
                "artifacts": [
                  "tests/security/test_output_sanitizer.py"
                ],
                "validation_rules": [
                  "pytest",
                  "coverage>=95%"
                ]
              },
              {
                "task_id": "T1.2.5",
                "description": "Write integration tests for sanitized logging",
                "type": "test",
                "estimated_tokens": 1000,
                "dependencies": ["T1.2.2"],
                "artifacts": [
                  "tests/integration/test_output_sanitization.py"
                ],
                "validation_rules": [
                  "pytest",
                  "verify-no-pii-in-logs"
                ]
              },
              {
                "task_id": "T1.2.6",
                "description": "Performance test sanitization overhead",
                "type": "test",
                "estimated_tokens": 800,
                "dependencies": ["T1.2.2"],
                "artifacts": [
                  "tests/performance/test_sanitization_overhead.py"
                ],
                "validation_rules": [
                  "benchmark-overhead<5%"
                ]
              },
              {
                "task_id": "T1.2.7",
                "description": "Update documentation for output sanitization",
                "type": "doc",
                "estimated_tokens": 600,
                "dependencies": ["T1.2.3"],
                "artifacts": [
                  "docs/guides/SECURITY.md",
                  "docs/guides/LOGGING.md"
                ],
                "validation_rules": [
                  "markdown-lint"
                ]
              }
            ]
          },
          {
            "story_id": "S1.3",
            "description": "QW-003: Confirmation for Destructive Git Operations",
            "acceptance_criteria": [
              "GitManager prompts for confirmation on force-push, hard-reset, clean, force-delete",
              "Interactive mode shows clear, specific prompts",
              "Headless mode denies by default (safe behavior)",
              "All dangerous operations logged to audit trail",
              "Zero accidental force-pushes",
              "Configuration option to whitelist operations"
            ],
            "tasks": [
              {
                "task_id": "T1.3.1",
                "description": "Enhance GitManager with dangerous operation detection",
                "type": "code",
                "estimated_tokens": 1500,
                "dependencies": [],
                "artifacts": [
                  "src/utils/git_manager.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy"
                ]
              },
              {
                "task_id": "T1.3.2",
                "description": "Implement confirmation prompts for interactive mode",
                "type": "code",
                "estimated_tokens": 1000,
                "dependencies": ["T1.3.1"],
                "artifacts": [
                  "src/utils/git_manager.py"
                ],
                "validation_rules": [
                  "integration-tests"
                ]
              },
              {
                "task_id": "T1.3.3",
                "description": "Implement safe defaults for headless mode",
                "type": "code",
                "estimated_tokens": 500,
                "dependencies": ["T1.3.1"],
                "artifacts": [
                  "src/utils/git_manager.py"
                ],
                "validation_rules": [
                  "unit-tests"
                ]
              },
              {
                "task_id": "T1.3.4",
                "description": "Add configuration for git operation confirmations",
                "type": "config",
                "estimated_tokens": 400,
                "dependencies": ["T1.3.1"],
                "artifacts": [
                  "src/core/config.py"
                ],
                "validation_rules": [
                  "schema-validation"
                ]
              },
              {
                "task_id": "T1.3.5",
                "description": "Write unit tests for GitManager confirmations",
                "type": "test",
                "estimated_tokens": 1200,
                "dependencies": ["T1.3.2", "T1.3.3"],
                "artifacts": [
                  "tests/utils/test_git_manager.py"
                ],
                "validation_rules": [
                  "pytest",
                  "coverage>=90%"
                ]
              },
              {
                "task_id": "T1.3.6",
                "description": "Update documentation for git confirmations",
                "type": "doc",
                "estimated_tokens": 500,
                "dependencies": ["T1.3.4"],
                "artifacts": [
                  "docs/guides/GIT_INTEGRATION.md"
                ],
                "validation_rules": [
                  "markdown-lint"
                ]
              }
            ]
          }
        ]
      },
      {
        "phase_id": "P2",
        "name": "UX Enhancement (Week 2 Part 1)",
        "description": "Implement specialized templates for bug fixes and refactoring",
        "estimated_tokens": 15000,
        "estimated_duration_hours": 28,
        "stories": [
          {
            "story_id": "S2.1",
            "description": "QW-004 & QW-005: Bug Fix and Refactoring Templates",
            "acceptance_criteria": [
              "BaseTemplate abstract class defined",
              "TemplateRegistry with auto-detection implemented",
              "BugFixTemplate detects bug-related keywords and generates 11-section prompt",
              "RefactoringTemplate detects refactor keywords and generates safety-focused prompt",
              "Integration with StructuredPromptBuilder seamless",
              "≥80% template adoption rate",
              "40% improvement in bug fix quality (measured via A/B test)"
            ],
            "tasks": [
              {
                "task_id": "T2.1.1",
                "description": "Create templates module structure",
                "type": "code",
                "estimated_tokens": 800,
                "dependencies": [],
                "artifacts": [
                  "src/llm/templates/__init__.py",
                  "src/llm/templates/base_template.py",
                  "src/llm/templates/registry.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy"
                ]
              },
              {
                "task_id": "T2.1.2",
                "description": "Implement BugFixTemplate with 11-section structure",
                "type": "code",
                "estimated_tokens": 2500,
                "dependencies": ["T2.1.1"],
                "artifacts": [
                  "src/llm/templates/bug_fix_template.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy",
                  "unit-tests"
                ]
              },
              {
                "task_id": "T2.1.3",
                "description": "Implement RefactoringTemplate with safety focus",
                "type": "code",
                "estimated_tokens": 2500,
                "dependencies": ["T2.1.1"],
                "artifacts": [
                  "src/llm/templates/refactoring_template.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy",
                  "unit-tests"
                ]
              },
              {
                "task_id": "T2.1.4",
                "description": "Integrate TemplateRegistry with StructuredPromptBuilder",
                "type": "code",
                "estimated_tokens": 1000,
                "dependencies": ["T2.1.2", "T2.1.3"],
                "artifacts": [
                  "src/llm/structured_prompt_builder.py"
                ],
                "validation_rules": [
                  "integration-tests"
                ]
              },
              {
                "task_id": "T2.1.5",
                "description": "Add CLI flag for manual template selection",
                "type": "code",
                "estimated_tokens": 500,
                "dependencies": ["T2.1.4"],
                "artifacts": [
                  "src/cli.py"
                ],
                "validation_rules": [
                  "cli-tests"
                ]
              },
              {
                "task_id": "T2.1.6",
                "description": "Add configuration for templates",
                "type": "config",
                "estimated_tokens": 400,
                "dependencies": ["T2.1.4"],
                "artifacts": [
                  "src/core/config.py"
                ],
                "validation_rules": [
                  "schema-validation"
                ]
              },
              {
                "task_id": "T2.1.7",
                "description": "Write unit tests for templates",
                "type": "test",
                "estimated_tokens": 2000,
                "dependencies": ["T2.1.2", "T2.1.3"],
                "artifacts": [
                  "tests/llm/templates/test_bug_fix_template.py",
                  "tests/llm/templates/test_refactoring_template.py",
                  "tests/llm/templates/test_registry.py"
                ],
                "validation_rules": [
                  "pytest",
                  "coverage>=90%"
                ]
              },
              {
                "task_id": "T2.1.8",
                "description": "Write integration tests for template system",
                "type": "test",
                "estimated_tokens": 1500,
                "dependencies": ["T2.1.4"],
                "artifacts": [
                  "tests/integration/test_template_system.py"
                ],
                "validation_rules": [
                  "pytest"
                ]
              },
              {
                "task_id": "T2.1.9",
                "description": "Setup A/B testing framework for template quality measurement",
                "type": "test",
                "estimated_tokens": 1500,
                "dependencies": ["T2.1.4"],
                "artifacts": [
                  "tests/ab_testing/test_template_quality.py"
                ],
                "validation_rules": [
                  "statistical-significance"
                ]
              },
              {
                "task_id": "T2.1.10",
                "description": "Update documentation for templates",
                "type": "doc",
                "estimated_tokens": 800,
                "dependencies": ["T2.1.6"],
                "artifacts": [
                  "docs/guides/TEMPLATES.md",
                  "CLAUDE.md"
                ],
                "validation_rules": [
                  "markdown-lint"
                ]
              }
            ]
          }
        ]
      },
      {
        "phase_id": "P3",
        "name": "Automation & Observability (Week 2 Part 2)",
        "description": "Implement approval timestamps, pre-commit hooks, quick reference, structured logging, correlation IDs",
        "estimated_tokens": 18000,
        "estimated_duration_hours": 32,
        "stories": [
          {
            "story_id": "S3.1",
            "description": "QW-006: Approval Gate Timestamps",
            "acceptance_criteria": [
              "approval_log table created with migration",
              "StateManager.log_approval() method implemented",
              "CommandProcessor logs all approvals with timestamp and user",
              "CLI command to view approval history works",
              "Complete audit trail for all approvals"
            ],
            "tasks": [
              {
                "task_id": "T3.1.1",
                "description": "Create database migration for approval_log table",
                "type": "code",
                "estimated_tokens": 800,
                "dependencies": [],
                "artifacts": [
                  "migrations/versions/004_approval_log.sql"
                ],
                "validation_rules": [
                  "migration-test"
                ]
              },
              {
                "task_id": "T3.1.2",
                "description": "Implement StateManager.log_approval() method",
                "type": "code",
                "estimated_tokens": 600,
                "dependencies": ["T3.1.1"],
                "artifacts": [
                  "src/core/state.py"
                ],
                "validation_rules": [
                  "unit-tests"
                ]
              },
              {
                "task_id": "T3.1.3",
                "description": "Update CommandProcessor to log approvals",
                "type": "code",
                "estimated_tokens": 500,
                "dependencies": ["T3.1.2"],
                "artifacts": [
                  "src/utils/command_processor.py"
                ],
                "validation_rules": [
                  "integration-tests"
                ]
              },
              {
                "task_id": "T3.1.4",
                "description": "Add CLI commands for viewing approval history",
                "type": "code",
                "estimated_tokens": 800,
                "dependencies": ["T3.1.2"],
                "artifacts": [
                  "src/cli.py"
                ],
                "validation_rules": [
                  "cli-tests"
                ]
              },
              {
                "task_id": "T3.1.5",
                "description": "Write tests for approval logging",
                "type": "test",
                "estimated_tokens": 1000,
                "dependencies": ["T3.1.3"],
                "artifacts": [
                  "tests/utils/test_approval_logging.py"
                ],
                "validation_rules": [
                  "pytest",
                  "coverage>=90%"
                ]
              },
              {
                "task_id": "T3.1.6",
                "description": "Update documentation for approval logging",
                "type": "doc",
                "estimated_tokens": 400,
                "dependencies": ["T3.1.4"],
                "artifacts": [
                  "docs/guides/INTERACTIVE_MODE.md"
                ],
                "validation_rules": [
                  "markdown-lint"
                ]
              }
            ]
          },
          {
            "story_id": "S3.2",
            "description": "QW-007: Pre-Commit Hook for Linting",
            "acceptance_criteria": [
              ".pre-commit-config.yaml configured with pylint, mypy, pytest (unit only)",
              "setup_pre_commit.sh script works",
              "Pre-commit hooks prevent broken code from being committed",
              "<5s execution time for typical commit",
              "Clear error messages when hooks fail",
              "Documentation complete"
            ],
            "tasks": [
              {
                "task_id": "T3.2.1",
                "description": "Create .pre-commit-config.yaml",
                "type": "config",
                "estimated_tokens": 800,
                "dependencies": [],
                "artifacts": [
                  ".pre-commit-config.yaml"
                ],
                "validation_rules": [
                  "yaml-validation"
                ]
              },
              {
                "task_id": "T3.2.2",
                "description": "Create setup_pre_commit.sh script",
                "type": "code",
                "estimated_tokens": 500,
                "dependencies": ["T3.2.1"],
                "artifacts": [
                  "scripts/setup_pre_commit.sh"
                ],
                "validation_rules": [
                  "bash-lint"
                ]
              },
              {
                "task_id": "T3.2.3",
                "description": "Create check_secrets.py script",
                "type": "code",
                "estimated_tokens": 600,
                "dependencies": [],
                "artifacts": [
                  "scripts/check_secrets.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy"
                ]
              },
              {
                "task_id": "T3.2.4",
                "description": "Update setup.sh to install pre-commit hooks",
                "type": "code",
                "estimated_tokens": 200,
                "dependencies": ["T3.2.2"],
                "artifacts": [
                  "setup.sh"
                ],
                "validation_rules": [
                  "bash-lint"
                ]
              },
              {
                "task_id": "T3.2.5",
                "description": "Test pre-commit hooks manually",
                "type": "test",
                "estimated_tokens": 800,
                "dependencies": ["T3.2.2"],
                "artifacts": [
                  "tests/manual/test_pre_commit_hooks.md"
                ],
                "validation_rules": [
                  "manual-test-checklist"
                ]
              },
              {
                "task_id": "T3.2.6",
                "description": "Update documentation for pre-commit hooks",
                "type": "doc",
                "estimated_tokens": 600,
                "dependencies": ["T3.2.4"],
                "artifacts": [
                  "docs/development/CONTRIBUTING.md"
                ],
                "validation_rules": [
                  "markdown-lint"
                ]
              }
            ]
          },
          {
            "story_id": "S3.3",
            "description": "QW-008: Quick Reference Card",
            "acceptance_criteria": [
              "QUICK_REFERENCE.md created with one-page format",
              "Covers 80% of common operations",
              "Included in obra --help output",
              "Easy to scan and find information"
            ],
            "tasks": [
              {
                "task_id": "T3.3.1",
                "description": "Create QUICK_REFERENCE.md",
                "type": "doc",
                "estimated_tokens": 1500,
                "dependencies": [],
                "artifacts": [
                  "docs/guides/QUICK_REFERENCE.md"
                ],
                "validation_rules": [
                  "markdown-lint",
                  "one-page-format"
                ]
              },
              {
                "task_id": "T3.3.2",
                "description": "Link quick reference from obra --help",
                "type": "code",
                "estimated_tokens": 300,
                "dependencies": ["T3.3.1"],
                "artifacts": [
                  "src/cli.py"
                ],
                "validation_rules": [
                  "cli-tests"
                ]
              }
            ]
          },
          {
            "story_id": "S3.4",
            "description": "QW-009 & QW-010: Structured Logging + Correlation IDs",
            "acceptance_criteria": [
              "StructuredLogger outputs valid JSON",
              "All logs include correlation ID",
              "correlation_scope context manager works",
              "Correlation ID consistent within task execution",
              "Easy to trace task lifecycle by correlation ID",
              "<5% performance overhead",
              "Logs integrated with OutputSanitizer"
            ],
            "tasks": [
              {
                "task_id": "T3.4.1",
                "description": "Implement correlation.py module",
                "type": "code",
                "estimated_tokens": 800,
                "dependencies": [],
                "artifacts": [
                  "src/core/correlation.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy",
                  "unit-tests"
                ]
              },
              {
                "task_id": "T3.4.2",
                "description": "Implement StructuredLogger",
                "type": "code",
                "estimated_tokens": 1200,
                "dependencies": ["T3.4.1"],
                "artifacts": [
                  "src/utils/structured_logger.py"
                ],
                "validation_rules": [
                  "pylint",
                  "mypy",
                  "unit-tests"
                ]
              },
              {
                "task_id": "T3.4.3",
                "description": "Integrate StructuredLogger with OutputSanitizer",
                "type": "code",
                "estimated_tokens": 500,
                "dependencies": ["T3.4.2"],
                "artifacts": [
                  "src/utils/structured_logger.py"
                ],
                "validation_rules": [
                  "integration-tests"
                ]
              },
              {
                "task_id": "T3.4.4",
                "description": "Replace all logging.getLogger() calls with get_logger()",
                "type": "code",
                "estimated_tokens": 2000,
                "dependencies": ["T3.4.3"],
                "artifacts": [
                  "src/orchestrator.py",
                  "src/agents/claude_code_local.py",
                  "src/core/state.py",
                  "src/utils/*.py"
                ],
                "validation_rules": [
                  "grep-for-old-logging"
                ]
              },
              {
                "task_id": "T3.4.5",
                "description": "Integrate correlation_scope with Orchestrator",
                "type": "code",
                "estimated_tokens": 600,
                "dependencies": ["T3.4.1"],
                "artifacts": [
                  "src/orchestrator.py"
                ],
                "validation_rules": [
                  "integration-tests"
                ]
              },
              {
                "task_id": "T3.4.6",
                "description": "Add CLI command for filtering logs by correlation ID",
                "type": "code",
                "estimated_tokens": 800,
                "dependencies": ["T3.4.5"],
                "artifacts": [
                  "src/cli.py"
                ],
                "validation_rules": [
                  "cli-tests"
                ]
              },
              {
                "task_id": "T3.4.7",
                "description": "Write unit tests for correlation module",
                "type": "test",
                "estimated_tokens": 1000,
                "dependencies": ["T3.4.1"],
                "artifacts": [
                  "tests/core/test_correlation.py"
                ],
                "validation_rules": [
                  "pytest",
                  "coverage>=95%"
                ]
              },
              {
                "task_id": "T3.4.8",
                "description": "Write unit tests for StructuredLogger",
                "type": "test",
                "estimated_tokens": 1200,
                "dependencies": ["T3.4.2"],
                "artifacts": [
                  "tests/utils/test_structured_logger.py"
                ],
                "validation_rules": [
                  "pytest",
                  "coverage>=95%"
                ]
              },
              {
                "task_id": "T3.4.9",
                "description": "Write integration tests for logging with correlation IDs",
                "type": "test",
                "estimated_tokens": 1500,
                "dependencies": ["T3.4.5"],
                "artifacts": [
                  "tests/integration/test_structured_logging.py"
                ],
                "validation_rules": [
                  "pytest",
                  "verify-json-valid",
                  "verify-correlation-ids"
                ]
              },
              {
                "task_id": "T3.4.10",
                "description": "Performance test logging overhead",
                "type": "test",
                "estimated_tokens": 800,
                "dependencies": ["T3.4.4"],
                "artifacts": [
                  "tests/performance/test_logging_overhead.py"
                ],
                "validation_rules": [
                  "benchmark-overhead<5%"
                ]
              },
              {
                "task_id": "T3.4.11",
                "description": "Update documentation for structured logging and correlation IDs",
                "type": "doc",
                "estimated_tokens": 1000,
                "dependencies": ["T3.4.6"],
                "artifacts": [
                  "docs/guides/LOGGING.md",
                  "docs/guides/DEBUGGING.md"
                ],
                "validation_rules": [
                  "markdown-lint"
                ]
              }
            ]
          }
        ]
      }
    ],
    "decision_records": [
      {
        "id": "ADR-QW001",
        "title": "Security Module Structure",
        "decision": "Create unified src/security/ module for all security features",
        "rationale": "Cohesive organization, easy to audit, prepares for v1.5.0 enhancements",
        "alternatives": [
          "Scatter security code across existing modules (rejected: hard to audit)",
          "Create security/ top-level directory (rejected: breaks existing structure)"
        ],
        "consequences": {
          "positive": ["Clear separation of concerns", "Easy to find security code", "Migration path to v1.5.0"],
          "negative": ["New directory to maintain"],
          "mitigations": ["Keep module focused, avoid bloat"]
        },
        "status": "accepted"
      },
      {
        "id": "ADR-QW002",
        "title": "Template System Architecture",
        "decision": "Use template registry pattern with auto-detection via keywords",
        "rationale": "Open/closed principle, easy to extend, backward compatible",
        "alternatives": [
          "Manual template selection only (rejected: poor UX)",
          "ML-based template detection (rejected: overengineering for v1.4.1)"
        ],
        "consequences": {
          "positive": ["Easy to add new templates", "Auto-detection works well", "Backward compatible"],
          "negative": ["Keyword detection may miss edge cases"],
          "mitigations": ["Allow manual override, iterate on keywords based on feedback"]
        },
        "status": "accepted"
      },
      {
        "id": "ADR-QW003",
        "title": "Logging Architecture",
        "decision": "Layered logging: StructuredLogger → Correlation → OutputSanitizer → Python logging",
        "rationale": "Single responsibility, composable, testable",
        "alternatives": [
          "Monolithic logger with all features (rejected: violates SRP)",
          "Separate loggers for each feature (rejected: fragmented)"
        ],
        "consequences": {
          "positive": ["Clear separation", "Easy to test", "Can enable/disable layers"],
          "negative": ["More abstraction layers", "Slight performance overhead"],
          "mitigations": ["Optimize hot paths", "Benchmark performance"]
        },
        "status": "accepted"
      },
      {
        "id": "ADR-QW004",
        "title": "Configuration Strategy",
        "decision": "Group config by feature in config.yaml (security, templates, logging, git, development)",
        "rationale": "Logical grouping, easy to understand, forward-compatible",
        "alternatives": [
          "Flat config (rejected: hard to navigate as features grow)",
          "Separate config files per feature (rejected: fragmented)"
        ],
        "consequences": {
          "positive": ["Easy to find related settings", "Scales well"],
          "negative": ["Config file grows"],
          "mitigations": ["Keep organized", "Document well"]
        },
        "status": "accepted"
      }
    ]
  },
  "state": {
    "current_phase": "P1",
    "current_story": "S1.1",
    "completed_tasks": [],
    "blocked_tasks": [],
    "status": "planning",
    "context_usage": {
      "tokens_used": 0,
      "tokens_available": 200000,
      "percentage": 0
    },
    "validation_results": {
      "lint": {"status": "not_run"},
      "tests": {"status": "not_run"},
      "security": {"status": "not_run"},
      "performance": {"status": "not_run"}
    }
  }
}
