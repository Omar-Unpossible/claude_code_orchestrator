"""Initial schema

Revision ID: 1a6a70f64ea3
Revises: 
Create Date: 2025-11-03 15:59:39.230392

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '1a6a70f64ea3'
down_revision: Union[str, Sequence[str], None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('pattern_learning',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('pattern_type', sa.String(length=100), nullable=False),
    sa.Column('pattern_key', sa.String(length=255), nullable=False),
    sa.Column('pattern_data', sa.JSON(), nullable=False),
    sa.Column('success_count', sa.Integer(), nullable=False),
    sa.Column('failure_count', sa.Integer(), nullable=False),
    sa.Column('last_used', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_pattern_type_key', 'pattern_learning', ['pattern_type', 'pattern_key'], unique=False)
    op.create_index(op.f('ix_pattern_learning_last_used'), 'pattern_learning', ['last_used'], unique=False)
    op.create_index(op.f('ix_pattern_learning_pattern_key'), 'pattern_learning', ['pattern_key'], unique=False)
    op.create_index(op.f('ix_pattern_learning_pattern_type'), 'pattern_learning', ['pattern_type'], unique=False)
    op.create_table('project_state',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('project_name', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('working_directory', sa.String(length=512), nullable=False),
    sa.Column('status', sa.Enum('ACTIVE', 'PAUSED', 'COMPLETED', 'ARCHIVED', name='projectstatus'), nullable=False),
    sa.Column('configuration', sa.JSON(), nullable=False),
    sa.Column('project_metadata', sa.JSON(), nullable=True),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_project_state_project_name'), 'project_state', ['project_name'], unique=True)
    op.create_index(op.f('ix_project_state_status'), 'project_state', ['status'], unique=False)
    op.create_table('checkpoint',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('project_id', sa.Integer(), nullable=False),
    sa.Column('checkpoint_type', sa.String(length=50), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('state_snapshot', sa.JSON(), nullable=False),
    sa.Column('created_by', sa.String(length=100), nullable=True),
    sa.Column('checkpoint_metadata', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['project_id'], ['project_state.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_checkpoint_checkpoint_type'), 'checkpoint', ['checkpoint_type'], unique=False)
    op.create_index(op.f('ix_checkpoint_created_at'), 'checkpoint', ['created_at'], unique=False)
    op.create_index(op.f('ix_checkpoint_project_id'), 'checkpoint', ['project_id'], unique=False)
    op.create_table('task',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('project_id', sa.Integer(), nullable=False),
    sa.Column('parent_task_id', sa.Integer(), nullable=True),
    sa.Column('title', sa.String(length=512), nullable=False),
    sa.Column('description', sa.Text(), nullable=False),
    sa.Column('status', sa.Enum('PENDING', 'READY', 'RUNNING', 'BLOCKED', 'COMPLETED', 'FAILED', 'CANCELLED', 'RETRYING', name='taskstatus'), nullable=False),
    sa.Column('assigned_to', sa.Enum('HUMAN', 'LOCAL_LLM', 'CLAUDE_CODE', 'SYSTEM', name='taskassignee'), nullable=False),
    sa.Column('priority', sa.Integer(), nullable=False),
    sa.Column('dependencies', sa.JSON(), nullable=True),
    sa.Column('context', sa.JSON(), nullable=True),
    sa.Column('result', sa.JSON(), nullable=True),
    sa.Column('retry_count', sa.Integer(), nullable=False),
    sa.Column('max_retries', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('started_at', sa.DateTime(), nullable=True),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.CheckConstraint('priority >= 1 AND priority <= 10', name='check_priority_range'),
    sa.ForeignKeyConstraint(['parent_task_id'], ['task.id'], ),
    sa.ForeignKeyConstraint(['project_id'], ['project_state.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_task_project_status', 'task', ['project_id', 'status'], unique=False)
    op.create_index(op.f('ix_task_parent_task_id'), 'task', ['parent_task_id'], unique=False)
    op.create_index(op.f('ix_task_priority'), 'task', ['priority'], unique=False)
    op.create_index(op.f('ix_task_project_id'), 'task', ['project_id'], unique=False)
    op.create_index(op.f('ix_task_status'), 'task', ['status'], unique=False)
    op.create_table('usage_tracking',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('project_id', sa.Integer(), nullable=False),
    sa.Column('date', sa.DateTime(), nullable=False),
    sa.Column('interactions_count', sa.Integer(), nullable=False),
    sa.Column('tasks_completed', sa.Integer(), nullable=False),
    sa.Column('tasks_failed', sa.Integer(), nullable=False),
    sa.Column('breakpoints_triggered', sa.Integer(), nullable=False),
    sa.Column('avg_confidence_score', sa.Float(), nullable=True),
    sa.Column('avg_quality_score', sa.Float(), nullable=True),
    sa.Column('total_duration_seconds', sa.Float(), nullable=False),
    sa.Column('metrics', sa.JSON(), nullable=True),
    sa.ForeignKeyConstraint(['project_id'], ['project_state.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_usage_project_date', 'usage_tracking', ['project_id', 'date'], unique=False)
    op.create_index(op.f('ix_usage_tracking_date'), 'usage_tracking', ['date'], unique=False)
    op.create_index(op.f('ix_usage_tracking_project_id'), 'usage_tracking', ['project_id'], unique=False)
    op.create_table('breakpoint_event',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('project_id', sa.Integer(), nullable=False),
    sa.Column('task_id', sa.Integer(), nullable=True),
    sa.Column('breakpoint_type', sa.String(length=100), nullable=False),
    sa.Column('reason', sa.Text(), nullable=False),
    sa.Column('severity', sa.Enum('LOW', 'MEDIUM', 'HIGH', 'CRITICAL', name='breakpointseverity'), nullable=False),
    sa.Column('context', sa.JSON(), nullable=True),
    sa.Column('resolved', sa.Boolean(), nullable=False),
    sa.Column('resolution', sa.Text(), nullable=True),
    sa.Column('resolved_by', sa.String(length=100), nullable=True),
    sa.Column('resolved_at', sa.DateTime(), nullable=True),
    sa.Column('triggered_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['project_id'], ['project_state.id'], ),
    sa.ForeignKeyConstraint(['task_id'], ['task.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_breakpoint_event_breakpoint_type'), 'breakpoint_event', ['breakpoint_type'], unique=False)
    op.create_index(op.f('ix_breakpoint_event_project_id'), 'breakpoint_event', ['project_id'], unique=False)
    op.create_index(op.f('ix_breakpoint_event_resolved'), 'breakpoint_event', ['resolved'], unique=False)
    op.create_index(op.f('ix_breakpoint_event_task_id'), 'breakpoint_event', ['task_id'], unique=False)
    op.create_table('file_state',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('project_id', sa.Integer(), nullable=False),
    sa.Column('task_id', sa.Integer(), nullable=True),
    sa.Column('file_path', sa.String(length=1024), nullable=False),
    sa.Column('file_hash', sa.String(length=64), nullable=False),
    sa.Column('file_size', sa.Integer(), nullable=False),
    sa.Column('change_type', sa.String(length=20), nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['project_id'], ['project_state.id'], ),
    sa.ForeignKeyConstraint(['task_id'], ['task.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_file_project_path', 'file_state', ['project_id', 'file_path'], unique=False)
    op.create_index(op.f('ix_file_state_created_at'), 'file_state', ['created_at'], unique=False)
    op.create_index(op.f('ix_file_state_file_path'), 'file_state', ['file_path'], unique=False)
    op.create_index(op.f('ix_file_state_project_id'), 'file_state', ['project_id'], unique=False)
    op.create_index(op.f('ix_file_state_task_id'), 'file_state', ['task_id'], unique=False)
    op.create_table('interaction',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('project_id', sa.Integer(), nullable=False),
    sa.Column('task_id', sa.Integer(), nullable=True),
    sa.Column('source', sa.Enum('LOCAL_LLM', 'CLAUDE_CODE', name='interactionsource'), nullable=False),
    sa.Column('prompt', sa.Text(), nullable=False),
    sa.Column('response', sa.Text(), nullable=True),
    sa.Column('confidence_score', sa.Float(), nullable=True),
    sa.Column('quality_score', sa.Float(), nullable=True),
    sa.Column('validation_passed', sa.Boolean(), nullable=True),
    sa.Column('timestamp', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('duration_seconds', sa.Float(), nullable=True),
    sa.Column('context', sa.JSON(), nullable=True),
    sa.CheckConstraint('confidence_score IS NULL OR (confidence_score >= 0.0 AND confidence_score <= 1.0)', name='check_confidence_range'),
    sa.CheckConstraint('quality_score IS NULL OR (quality_score >= 0.0 AND quality_score <= 100.0)', name='check_quality_range'),
    sa.ForeignKeyConstraint(['project_id'], ['project_state.id'], ),
    sa.ForeignKeyConstraint(['task_id'], ['task.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_interaction_project_task_time', 'interaction', ['project_id', 'task_id', 'timestamp'], unique=False)
    op.create_index(op.f('ix_interaction_project_id'), 'interaction', ['project_id'], unique=False)
    op.create_index(op.f('ix_interaction_source'), 'interaction', ['source'], unique=False)
    op.create_index(op.f('ix_interaction_task_id'), 'interaction', ['task_id'], unique=False)
    op.create_index(op.f('ix_interaction_timestamp'), 'interaction', ['timestamp'], unique=False)
    op.create_table('parameter_effectiveness',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('template_name', sa.String(length=100), nullable=False),
    sa.Column('parameter_name', sa.String(length=100), nullable=False),
    sa.Column('was_included', sa.Boolean(), nullable=False),
    sa.Column('validation_accurate', sa.Boolean(), nullable=True),
    sa.Column('task_id', sa.Integer(), nullable=True),
    sa.Column('prompt_token_count', sa.Integer(), nullable=True),
    sa.Column('parameter_token_count', sa.Integer(), nullable=True),
    sa.Column('timestamp', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['task_id'], ['task.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_param_eff_task_template', 'parameter_effectiveness', ['task_id', 'template_name'], unique=False)
    op.create_index('idx_param_eff_template_param', 'parameter_effectiveness', ['template_name', 'parameter_name'], unique=False)
    op.create_index(op.f('ix_parameter_effectiveness_parameter_name'), 'parameter_effectiveness', ['parameter_name'], unique=False)
    op.create_index(op.f('ix_parameter_effectiveness_task_id'), 'parameter_effectiveness', ['task_id'], unique=False)
    op.create_index(op.f('ix_parameter_effectiveness_template_name'), 'parameter_effectiveness', ['template_name'], unique=False)
    op.create_index(op.f('ix_parameter_effectiveness_timestamp'), 'parameter_effectiveness', ['timestamp'], unique=False)
    op.create_index(op.f('ix_parameter_effectiveness_validation_accurate'), 'parameter_effectiveness', ['validation_accurate'], unique=False)
    op.create_index(op.f('ix_parameter_effectiveness_was_included'), 'parameter_effectiveness', ['was_included'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_parameter_effectiveness_was_included'), table_name='parameter_effectiveness')
    op.drop_index(op.f('ix_parameter_effectiveness_validation_accurate'), table_name='parameter_effectiveness')
    op.drop_index(op.f('ix_parameter_effectiveness_timestamp'), table_name='parameter_effectiveness')
    op.drop_index(op.f('ix_parameter_effectiveness_template_name'), table_name='parameter_effectiveness')
    op.drop_index(op.f('ix_parameter_effectiveness_task_id'), table_name='parameter_effectiveness')
    op.drop_index(op.f('ix_parameter_effectiveness_parameter_name'), table_name='parameter_effectiveness')
    op.drop_index('idx_param_eff_template_param', table_name='parameter_effectiveness')
    op.drop_index('idx_param_eff_task_template', table_name='parameter_effectiveness')
    op.drop_table('parameter_effectiveness')
    op.drop_index(op.f('ix_interaction_timestamp'), table_name='interaction')
    op.drop_index(op.f('ix_interaction_task_id'), table_name='interaction')
    op.drop_index(op.f('ix_interaction_source'), table_name='interaction')
    op.drop_index(op.f('ix_interaction_project_id'), table_name='interaction')
    op.drop_index('idx_interaction_project_task_time', table_name='interaction')
    op.drop_table('interaction')
    op.drop_index(op.f('ix_file_state_task_id'), table_name='file_state')
    op.drop_index(op.f('ix_file_state_project_id'), table_name='file_state')
    op.drop_index(op.f('ix_file_state_file_path'), table_name='file_state')
    op.drop_index(op.f('ix_file_state_created_at'), table_name='file_state')
    op.drop_index('idx_file_project_path', table_name='file_state')
    op.drop_table('file_state')
    op.drop_index(op.f('ix_breakpoint_event_task_id'), table_name='breakpoint_event')
    op.drop_index(op.f('ix_breakpoint_event_resolved'), table_name='breakpoint_event')
    op.drop_index(op.f('ix_breakpoint_event_project_id'), table_name='breakpoint_event')
    op.drop_index(op.f('ix_breakpoint_event_breakpoint_type'), table_name='breakpoint_event')
    op.drop_table('breakpoint_event')
    op.drop_index(op.f('ix_usage_tracking_project_id'), table_name='usage_tracking')
    op.drop_index(op.f('ix_usage_tracking_date'), table_name='usage_tracking')
    op.drop_index('idx_usage_project_date', table_name='usage_tracking')
    op.drop_table('usage_tracking')
    op.drop_index(op.f('ix_task_status'), table_name='task')
    op.drop_index(op.f('ix_task_project_id'), table_name='task')
    op.drop_index(op.f('ix_task_priority'), table_name='task')
    op.drop_index(op.f('ix_task_parent_task_id'), table_name='task')
    op.drop_index('idx_task_project_status', table_name='task')
    op.drop_table('task')
    op.drop_index(op.f('ix_checkpoint_project_id'), table_name='checkpoint')
    op.drop_index(op.f('ix_checkpoint_created_at'), table_name='checkpoint')
    op.drop_index(op.f('ix_checkpoint_checkpoint_type'), table_name='checkpoint')
    op.drop_table('checkpoint')
    op.drop_index(op.f('ix_project_state_status'), table_name='project_state')
    op.drop_index(op.f('ix_project_state_project_name'), table_name='project_state')
    op.drop_table('project_state')
    op.drop_index(op.f('ix_pattern_learning_pattern_type'), table_name='pattern_learning')
    op.drop_index(op.f('ix_pattern_learning_pattern_key'), table_name='pattern_learning')
    op.drop_index(op.f('ix_pattern_learning_last_used'), table_name='pattern_learning')
    op.drop_index('idx_pattern_type_key', table_name='pattern_learning')
    op.drop_table('pattern_learning')
    # ### end Alembic commands ###
