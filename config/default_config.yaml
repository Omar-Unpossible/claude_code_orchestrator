# Default configuration for Claude Code Orchestrator
# This file provides sensible defaults for all settings.
# Override in config/config.yaml or via environment variables.

# LLM Configuration (Orchestrator)
# Two options: local (ollama) or remote (openai-codex)

# OPTION A: Local LLM (Ollama with Qwen) - Hardware deployment
llm:
  type: ollama  # LLM provider type (matches LLMRegistry)
  model: qwen2.5-coder:32b  # Model to use
  api_url: http://localhost:11434  # Ollama API endpoint
  temperature: 0.7  # Generation temperature (0.0-2.0)
  timeout: 30  # Timeout for generation (seconds)
  max_tokens: 4096  # Maximum tokens to generate
  context_length: 32768  # Model context window size

# OPTION B: Remote LLM (OpenAI Codex CLI) - Subscription or API key deployment
# Uncomment and configure to use:
# llm:
#   type: openai-codex  # LLM provider type (matches LLMRegistry)
#   codex_command: codex  # CLI command (or full path: /usr/local/bin/codex)
#   model: codex-mini-latest  # Model: codex-mini-latest, gpt-5-codex, o3, gpt-5, o4-mini
#   full_auto: true  # Use --full-auto for automatic execution
#   json_output: false  # Use --json for JSONL output
#   timeout: 120  # Timeout for CLI subprocess (seconds)
#   retry_attempts: 3  # Number of retry attempts on failure
#   # Authentication: OPENAI_API_KEY env var or `codex --login` (OAuth)

# Agent Configuration
agent:
  # Agent type: mock (testing), claude_code_local (same machine), claude_code_ssh (remote)
  type: mock
  timeout: 120  # Default timeout for agent operations (seconds)
  max_retries: 3  # Maximum retry attempts on failure
  workspace_path: ./workspace  # Agent workspace directory

  # Local agent config (for claude_code_local agent)
  # Runs Claude Code CLI as subprocess on same machine
  # Use for: development, single-host deployment, low latency
  local:
    command: claude  # Claude Code CLI command (or full path)
    workspace_dir: ./workspace  # Workspace directory for agent
    timeout_ready: 30  # Seconds to wait for agent ready signal
    timeout_response: 120  # Seconds to wait for response

  # SSH-specific config (for claude_code_ssh agent)
  # Runs Claude Code CLI on remote machine via SSH
  # Use for: production, isolated VM, strong isolation
  ssh:
    host: localhost
    port: 22
    user: claude
    key_path: ~/.ssh/id_rsa
    # Note: Set via ORCHESTRATOR_AGENT_SSH_KEY_PATH env var for security

  # Docker-specific config (for claude_code_docker agent)
  docker:
    image: claude-code:latest
    container_name: claude-agent
    workspace_mount: ./workspace

# Database Configuration
database:
  url: sqlite:///data/orchestrator.db  # SQLite for simplicity
  # For PostgreSQL: postgresql://user:password@localhost/orchestrator
  pool_size: 10  # Connection pool size
  max_overflow: 20  # Max overflow connections
  echo: false  # Log SQL queries (set true for debugging)

# File Monitoring
monitoring:
  file_watcher:
    enabled: true
    debounce_ms: 500  # Debounce rapid changes
    ignore_patterns:
      - "**/__pycache__/**"
      - "**/.git/**"
      - "**/.venv/**"
      - "**/*.pyc"
      - "**/node_modules/**"

  output_monitor:
    completion_markers:
      - "Task completed"
      - "Done"
      - "Finished"
    error_markers:
      - "Error:"
      - "Failed:"
      - "Exception:"

# Orchestration Settings
orchestration:
  max_iterations: 50  # Maximum iterations per task
  iteration_timeout: 300  # Timeout per iteration (seconds)
  task_timeout: 3600  # Overall task timeout (seconds)
  concurrent_tasks: 1  # Number of tasks to run in parallel
  auto_retry: true  # Automatically retry failed operations

# Breakpoint Configuration
breakpoints:
  enabled: true  # Enable breakpoint system
  auto_resolve_timeout: 300  # Auto-resolve timeout (seconds, 0 = wait forever)

  # When to trigger breakpoints
  triggers:
    low_confidence:
      enabled: true
      threshold: 30  # Confidence below this triggers breakpoint
    quality_too_low:
      enabled: true
      threshold: 50  # Quality score below this triggers breakpoint
    validation_failed:
      enabled: true
      max_retries: 3  # Trigger after this many validation failures
    rate_limit_hit:
      enabled: true
    unexpected_error:
      enabled: true

# Validation Settings
validation:
  response:
    check_completeness: true
    check_code_blocks_closed: true
    min_length: 10  # Minimum response length (characters)

  quality:
    enabled: true
    threshold: 70  # Minimum acceptable quality score (0-100)
    run_tests: true  # Execute tests if applicable
    check_syntax: true  # Validate code syntax

# Confidence Scoring
confidence:
  threshold: 50  # Minimum confidence to proceed without breakpoint
  weights:
    validation: 0.3  # Weight for validation result
    quality: 0.4  # Weight for quality score
    agent_health: 0.1  # Weight for agent health status
    retry_count: 0.2  # Weight for number of retries

# Context Management
context:
  max_tokens: 8000  # Maximum context tokens to include in prompts
  prioritization:
    - recent_interactions  # Most recent interactions (highest priority)
    - task_description  # Current task description
    - relevant_files  # Files mentioned in task
    - project_context  # General project context

  summarization:
    enabled: true  # Summarize old context when limit reached
    keep_recent: 5  # Keep this many recent interactions unsummarized

# Logging
logging:
  level: INFO  # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file: logs/orchestrator.log  # Log file path
  max_bytes: 10485760  # Max log file size (10MB)
  backup_count: 5  # Number of backup files to keep

# Prompt Templates
prompts:
  template_dir: config/prompt_templates  # Directory for Jinja2 templates

# Performance
performance:
  enable_caching: true  # Enable caching where applicable
  cache_ttl: 300  # Cache time-to-live (seconds)

# M9: Retry Configuration
retry:
  max_attempts: 5  # Maximum number of retry attempts
  base_delay: 1.0  # Initial delay in seconds
  max_delay: 60.0  # Maximum delay in seconds
  backoff_multiplier: 2.0  # Exponential backoff multiplier (1s → 2s → 4s → 8s)
  jitter: 0.1  # Random jitter factor (0.0-1.0) to prevent thundering herd
  retryable_errors:  # Error patterns that should trigger retry
    - "rate limit"
    - "rate_limit"
    - "too many requests"
    - "timeout"
    - "timed out"
    - "connection"
    - "network"
    - "service unavailable"
    - "temporarily unavailable"
    - "try again"

# M9: Task Dependencies
dependencies:
  max_depth: 10  # Maximum dependency chain depth
  allow_cycles: false  # Whether to allow circular dependencies
  fail_on_dependency_error: true  # Fail task if dependency fails

# M9: Git Integration
git:
  enabled: false  # Enable git auto-integration (opt-in)
  auto_commit: true  # Automatically commit after task completion
  commit_strategy: per_task  # per_task | per_milestone | manual
  create_branch: true  # Create branch per task
  branch_prefix: "obra/task-"  # Branch name prefix
  auto_pr: false  # Automatically create pull requests
  pr_base_branch: main  # Base branch for PRs
  commit_message_template: semantic  # Commit message style
  include_metadata: true  # Include Obra metadata in commits

# Natural Language Command Interface (Story 4-5)
nl_commands:
  enabled: true  # Enable NL command processing (master kill switch)
  llm_provider: ollama  # LLM provider for NL processing (uses llm.type if not specified)
  confidence_threshold: 0.7  # Threshold for CLARIFICATION_NEEDED
  max_context_turns: 10  # Maximum conversation history turns to keep
  schema_path: src/nl/schemas/obra_schema.json  # Path to Obra schema for entity extraction
  default_project_id: 1  # Default project ID if not specified
  require_confirmation_for:  # Operations requiring user confirmation
    - delete
    - update
    - execute
  fallback_to_info: true  # Fallback to informational response for QUESTION intent
  experimental_features: false  # Enable experimental NL features

# ADR-015: Project Infrastructure Maintenance System (v1.4.0)
# Automatic documentation maintenance at key project events
documentation:
  enabled: true  # Master enable/disable switch for documentation maintenance
  auto_maintain: true  # Automatically create maintenance tasks (vs just notify)

  # Event-driven triggers
  triggers:
    # Epic completion: Lightweight update (CHANGELOG, architecture if needed)
    epic_complete:
      enabled: true  # Enable epic completion trigger
      scope: lightweight  # Maintenance scope: lightweight | comprehensive | full_review
      auto_create_task: true  # Automatically create task (vs notification only)

    # Milestone achievement: Comprehensive update (all docs, ADRs, archiving)
    milestone_achieved:
      enabled: true  # Enable milestone achievement trigger
      scope: comprehensive  # Always comprehensive for milestones
      auto_create_task: true  # Automatically create task

    # Version bump: Full documentation review
    version_bump:
      enabled: true  # Enable version bump trigger
      scope: full_review  # Full review of all documentation
      auto_create_task: true  # Automatically create task

    # Periodic checks: Regular freshness scanning (Story 2.1)
    periodic:
      enabled: true  # Enable periodic freshness checks
      interval_days: 7  # Check interval in days (7 = weekly, 30 = monthly)
      scope: lightweight  # Maintenance scope: lightweight | comprehensive | full_review
      auto_create_task: true  # Automatically create task (vs notification only)

  # Documents to maintain (paths relative to project root)
  maintenance_targets:
    - CHANGELOG.md  # Project changelog
    - docs/architecture/ARCHITECTURE.md  # System architecture
    - docs/README.md  # Documentation index
    - docs/decisions/  # Architecture Decision Records (ADRs)
    - docs/guides/  # User and developer guides

  # Freshness thresholds (days since last update)
  freshness_thresholds:
    critical: 30  # CHANGELOG, README (update within 30 days)
    important: 60  # Architecture docs, ADRs (update within 60 days)
    normal: 90  # Guides, design docs (update within 90 days)

  # Archive settings for completed implementation plans
  archive:
    enabled: true  # Enable automatic archiving
    source_dir: docs/development  # Source directory to scan
    archive_dir: docs/archive/development  # Archive destination
    patterns:  # File patterns to archive (glob syntax)
      - "*_IMPLEMENTATION_PLAN.md"
      - "*_COMPLETION_PLAN.md"
      - "*_GUIDE.md"

  # Maintenance task configuration
  task_config:
    priority: 3  # Task priority (1-10, lower = higher priority)
    assigned_agent: null  # null = use default agent from agent.type
    assigned_llm: null  # null = use default LLM from llm.type
    auto_execute: false  # Require manual approval before execution

# Development/Debug Settings (disable in production)
debug:
  enabled: false  # Enable debug mode
  save_interactions: true  # Save all interactions for debugging
  verbose_logging: false  # Extra verbose logging
