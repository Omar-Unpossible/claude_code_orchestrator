# Prompt Templates for Claude Code Orchestrator
# Uses Jinja2 templating syntax with custom filters

# Task execution template - used for generating prompts for Claude Code
task_execution: |
  You are working on the following task for the "{{ project_name }}" project.

  ## Task Information
  **Task ID**: {{ task_id }}
  **Title**: {{ task_title }}
  **Description**: {{ task_description }}
  **Priority**: {{ task_priority | default(5) }}
  {% if task_dependencies_detailed %}

  ### Dependencies ({{ task_dependencies_detailed | length }})
  This task depends on the following tasks completing first:
  {% for dep in task_dependencies_detailed %}
  - **Task #{{ dep.id }}**: {{ dep.title }}
    - Status: {{ dep.status }}
    {% if dep.completion_percentage is defined %}
    - Completion: {{ dep.completion_percentage }}%
    {% endif %}
    {% if dep.output %}
    - Output Summary: {{ dep.output | truncate(200) }}
    {% endif %}
    {% if dep.blocking_reason %}
    - ‚ö†Ô∏è  Blocking: {{ dep.blocking_reason }}
    {% endif %}
  {% endfor %}
  {% elif task_dependencies %}
  **Dependencies**: {{ task_dependencies | join(', ') }}
  {% endif %}

  {% if retry_context %}
  ## üîÑ Retry Information
  **Attempt**: {{ retry_context.attempt_number }} of {{ retry_context.max_attempts }}
  **Previous Failure**: {{ retry_context.failure_reason }}
  **What to improve**: {{ retry_context.improvements | join(', ') }}
  {% if retry_context.previous_errors %}
  **Errors from last attempt**:
  {% for error in retry_context.previous_errors %}
  - {{ error }}
  {% endfor %}
  {% endif %}
  {% endif %}

  ## Project Context
  Working Directory: {{ working_directory }}
  {% if project_goals %}
  Project Goals:
  {{ project_goals | truncate(500) }}
  {% endif %}

  {% if git_context %}
  ## Recent Changes (Git)
  {% if git_context.recent_commits %}
  Recent commits in this branch:
  {% for commit in git_context.recent_commits[:3] %}
  - {{ commit.hash[:7] }}: {{ commit.message }} ({{ commit.author }}, {{ commit.timestamp }})
  {% endfor %}
  {% endif %}
  {% if git_context.current_branch %}
  Current branch: {{ git_context.current_branch }}
  {% endif %}
  {% if git_context.uncommitted_changes %}
  ‚ö†Ô∏è  {{ git_context.uncommitted_changes }} uncommitted changes
  {% endif %}
  {% endif %}

  {% if current_files %}
  ## Current Active Files
  {% for file in current_files %}
  - {{ file.path }} ({{ file.size }} bytes, last modified: {{ file.modified }})
  {% endfor %}
  {% endif %}

  {% if recent_errors %}
  ## Recent Errors to Address
  {% for error in recent_errors %}
  - {{ error.message }} ({{ error.timestamp }})
  {% endfor %}
  {% endif %}

  {% if conversation_history %}
  ## Recent Conversation
  {{ conversation_history | summarize(max_tokens=1000) }}
  {% endif %}

  {% if examples %}
  ## Example Solutions
  {% for example in examples %}
  ### Example {{ loop.index }}
  {{ example.description }}
  ```{{ example.language | default('python') }}
  {{ example.code | format_code }}
  ```
  {% endfor %}
  {% endif %}

  ## Instructions
  {{ instructions }}

  Please complete this task efficiently and report your progress.

# Validation prompt - for QualityController to validate work
validation: |
  You are validating the work completed for the following task.

  ## Task Details
  **Task**: {{ task_title }}
  **Description**: {{ task_description }}
  **Expected Outcome**: {{ expected_outcome }}
  {% if task_dependencies %}
  **Upstream Dependencies**: {{ task_dependencies | join(', ') }}
  {% endif %}

  ## Work Submitted
  {{ work_output | truncate(3000) }}

  {% if file_changes %}
  ## Files Changed ({{ file_changes | length }} files)
  {% for change in file_changes %}
  ### {{ change.path }} ({{ change.change_type }})
  **Summary**: {{ change.summary }}
  {% if change.diff %}
  **Changes**:
  ```diff
  {{ change.diff | truncate(500) }}
  ```
  {% endif %}
  {% if change.lines_added is defined and change.lines_removed is defined %}
  **Lines**: +{{ change.lines_added }} -{{ change.lines_removed }}
  {% endif %}
  {% endfor %}
  {% endif %}

  {% if git_validation %}
  ## Git Validation
  **Commit Hash**: {{ git_validation.commit_hash }}
  **Files in Commit**: {{ git_validation.files_count }}
  **Commit Message**: {{ git_validation.message }}
  {% if git_validation.branch %}
  **Branch**: {{ git_validation.branch }}
  {% endif %}
  {% endif %}

  {% if dependency_impact %}
  ## Dependency Impact Analysis
  {% if dependency_impact.affected_tasks %}
  **Downstream Tasks Affected**: {{ dependency_impact.affected_tasks | join(', ') }}
  {% endif %}
  {% if dependency_impact.breaking_changes %}
  **‚ö†Ô∏è  Potential Breaking Changes**: {{ dependency_impact.breaking_changes | length }}
  {% for breaking in dependency_impact.breaking_changes %}
  - {{ breaking }}
  {% endfor %}
  {% endif %}
  {% endif %}

  {% if test_results %}
  ## Test Results
  {{ test_results | summarize(max_tokens=500) }}
  {% endif %}

  {% if retry_context %}
  ## Retry Context
  This is attempt {{ retry_context.attempt_number }} of {{ retry_context.max_attempts }}.
  **Previous failure**: {{ retry_context.failure_reason }}
  **Improvements made**: {{ retry_context.improvements | join(', ') }}
  {% endif %}

  ## Validation Criteria
  Please assess the work against these criteria:
  {% for criterion in validation_criteria %}
  - {{ criterion }}
  {% endfor %}

  **RESPOND WITH ONLY A VALID JSON OBJECT. NO PREAMBLE OR EXPLANATION.**

  Required JSON format:
  {
    "is_valid": true,
    "quality_score": 0.85,
    "issues": ["Issue 1", "Issue 2"],
    "suggestions": ["Suggestion 1"],
    "dependency_concerns": ["Concern 1"],
    "reasoning": "Brief explanation"
  }

  Your JSON response:

# Error analysis prompt - for local LLM to analyze failures
error_analysis: |
  An error occurred during task execution. Please analyze it.

  ## Error Details
  **Error Type**: {{ error_type }}
  **Error Message**: {{ error_message }}
  {% if error_stacktrace %}
  **Stacktrace**:
  ```
  {{ error_stacktrace | truncate(1500) }}
  ```
  {% endif %}

  ## Task Context
  **Task**: {{ task_title }}
  {{ task_description | truncate(300) }}

  ## Agent Output
  {{ agent_output | truncate(1000) }}

  {% if recent_interactions %}
  ## Recent Interactions
  {% for interaction in recent_interactions %}
  - {{ interaction.timestamp }}: {{ interaction.summary }}
  {% endfor %}
  {% endif %}

  ## Analysis Required
  Please analyze this error and provide:
  1. Root cause identification
  2. Whether this is recoverable with a retry
  3. Suggested fix or next steps
  4. Whether human intervention is needed

  Respond in JSON format with these fields.

# Decision prompt - for DecisionEngine to decide next action
decision: |
  Based on the current state, determine the next action.

  ## Current Task
  **Task ID**: {{ task_id }}
  **Title**: {{ task_title }}
  **Status**: {{ task_status }}
  **Attempts**: {{ attempt_count }} / {{ max_attempts }}

  ## Latest Interaction
  **Agent**: {{ agent_name }}
  **Response**: {{ agent_response | truncate(800) }}
  {% if validation_result %}
  **Validation**: {{ validation_result.is_valid }} (score: {{ validation_result.quality_score }})
  {% if validation_result.issues %}
  **Issues Found**: {{ validation_result.issues | join(', ') }}
  {% endif %}
  {% endif %}

  ## Project State
  **Active Tasks**: {{ active_task_count }}
  **Pending Tasks**: {{ pending_task_count }}
  **Recent Breakpoints**: {{ recent_breakpoint_count }}

  {% if context %}
  ## Additional Context
  {{ context | summarize(max_tokens=500) }}
  {% endif %}

  ## Decision Options
  1. PROCEED - Task completed successfully, move to next task
  2. RETRY - Task failed but recoverable, retry with improved prompt
  3. BREAKPOINT - Human intervention needed
  4. DELEGATE - Assign to different agent
  5. SKIP - Mark task as blocked, move to next

  Please decide the best action and explain your reasoning.

# Summarization prompt - for condensing long content
summarization: |
  Please provide a concise summary of the following content.

  {% if content_type %}
  Content Type: {{ content_type }}
  {% endif %}

  Target Length: {{ target_tokens | default(500) }} tokens

  ## Content
  {{ content }}

  ## Summary Requirements
  - Focus on key information relevant to {{ focus | default('task completion') }}
  - Preserve critical details
  - Remove redundancy and verbose explanations
  - Maintain technical accuracy

  Provide only the summary, no preamble.

# Breakpoint notification - for human review
breakpoint_notification: |
  BREAKPOINT TRIGGERED

  ## Severity: {{ severity | upper }}

  ## Reason
  {{ reason }}

  ## Task Information
  **Task**: {{ task_title }}
  **Status**: {{ task_status }}
  **Project**: {{ project_name }}

  {% if context %}
  ## Context
  {{ context | truncate(1000) }}
  {% endif %}

  {% if agent_output %}
  ## Last Agent Output
  {{ agent_output | truncate(800) }}
  {% endif %}

  {% if suggested_actions %}
  ## Suggested Actions
  {% for action in suggested_actions %}
  {{ loop.index }}. {{ action }}
  {% endfor %}
  {% endif %}

  Please review and provide guidance on how to proceed.

# Follow-up prompt generation - for PromptGenerator to create optimized retry prompts
followup_generation: |
  Generate an improved prompt for retrying a failed task.

  ## Original Task
  {{ original_task_description }}

  ## Original Prompt
  {{ original_prompt | truncate(1000) }}

  ## What Went Wrong
  {{ failure_reason }}
  {% if validation_issues %}
  Validation Issues:
  {% for issue in validation_issues %}
  - {{ issue }}
  {% endfor %}
  {% endif %}

  ## Previous Attempts
  This is attempt {{ attempt_number }} of {{ max_attempts }}.

  {% if learned_patterns %}
  ## Learned Patterns (what worked before)
  {% for pattern in learned_patterns %}
  - {{ pattern.description }}: {{ pattern.solution | truncate(200) }}
  {% endfor %}
  {% endif %}

  ## Requirements for Improved Prompt
  - Address the specific failures from previous attempt
  - Add clearer constraints and requirements
  - Include relevant examples if available
  - Be more specific about expected output format
  - Keep token count under {{ max_tokens | default(3000) }}

  Generate the improved prompt text only.

# Code review prompt - for reviewing code changes
code_review: |
  Review the following code changes for quality and correctness.

  ## Context
  **Task**: {{ task_title }}
  **Files Changed**: {{ files_changed | length }}

  {% for file in file_changes %}
  ### {{ file.path }}
  **Change Type**: {{ file.change_type }}
  {% if file.diff %}
  ```diff
  {{ file.diff | truncate(2000) }}
  ```
  {% endif %}
  {% endfor %}

  ## Review Criteria
  - Code correctness and logic
  - Error handling
  - Code style and readability
  - Performance considerations
  - Security implications
  - Test coverage

  {% if project_standards %}
  ## Project Standards
  {{ project_standards | truncate(500) }}
  {% endif %}

  Provide feedback in JSON format with:
  - "approved": boolean
  - "severity": "low" | "medium" | "high" (highest issue severity)
  - "issues": list of {"file": str, "line": int, "severity": str, "message": str}
  - "suggestions": list of improvement recommendations

# Context extraction - for extracting relevant context from codebase
context_extraction: |
  Extract relevant context for the following task.

  ## Task
  {{ task_description }}

  ## Codebase Information
  Working Directory: {{ working_directory }}
  Total Files: {{ total_files }}

  {% if file_patterns %}
  Relevant File Patterns:
  {% for pattern in file_patterns %}
  - {{ pattern }}
  {% endfor %}
  {% endif %}

  ## What to Extract
  1. Related source files and their purposes
  2. Relevant dependencies and imports
  3. Existing implementations of similar functionality
  4. Configuration files that might be affected
  5. Test files that should be updated

  Provide a structured summary focusing on information needed to complete the task.

# Simple instruction prompt - minimal template for basic commands
simple_instruction: |
  {{ instruction }}
  {% if context %}

  Context: {{ context }}
  {% endif %}
