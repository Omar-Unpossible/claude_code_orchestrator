# Configuration for Claude Code Orchestrator
# Supports both local LLM (Ollama) and remote LLM (OpenAI Codex) orchestration
# See config/default_config.yaml for all options

# Local LLM Configuration (Ollama)
llm:
  type: ollama  # LLM provider type (matches LLMRegistry)
  model: qwen2.5-coder:32b  # Model to use
  api_url: http://10.0.75.1:11434  # Ollama API endpoint (Host machine on vEthernet DevSwitch)
  temperature: 0.7  # Generation temperature (0.0-2.0)
  timeout: 30  # Timeout for generation (seconds)
  max_tokens: 4096  # Maximum tokens to generate
  context_length: 32768  # Model context window size

# Agent Configuration
agent:
  type: claude-code-local  # Agent type (claude-code-local for headless, claude-code-ssh for remote)
  timeout: 120  # Default timeout for agent operations (seconds)
  max_retries: 3  # Maximum retry attempts on failure
  workspace_path: /home/omarwsl/obra-runtime/workspace  # Agent workspace directory

  # Local headless agent config (recommended - uses subprocess with --print)
  local:
    claude_command: claude  # Command to run (default: 'claude')
    # Response timeout: 7200 seconds = 2 hours
    # Allows complex workflows to complete without interruption
    # Separate from max_turns: timeout is WALL-CLOCK time, max_turns is ITERATION limit
    response_timeout: 7200
    bypass_permissions: true  # Enable dangerous mode (automatic permission bypass)
    use_session_persistence: false  # Use fresh session per call (more reliable)

  # SSH-specific config (for claude-code-ssh agent - remote execution)
  ssh:
    host: localhost
    port: 22
    user: claude
    key_path: ~/.ssh/id_rsa
    # Note: Set via ORCHESTRATOR_AGENT_SSH_KEY_PATH env var for security

  # Docker-specific config (for claude-code-docker agent)
  docker:
    image: claude-code:latest
    container_name: claude-agent
    workspace_mount: ./workspace

# Database Configuration
database:
  url: sqlite:////home/omarwsl/obra-runtime/data/orchestrator.db  # SQLite for simplicity
  # For PostgreSQL: postgresql://user:password@localhost/orchestrator
  pool_size: 10  # Connection pool size
  max_overflow: 20  # Max overflow connections
  echo: false  # Log SQL queries (set true for debugging)

# File Monitoring
monitoring:
  file_watcher:
    enabled: true
    debounce_ms: 500  # Debounce rapid changes
    ignore_patterns:
      - "**/__pycache__/**"
      - "**/.git/**"
      - "**/.venv/**"
      - "**/*.pyc"
      - "**/node_modules/**"

  output_monitor:
    completion_markers:
      - "Task completed"
      - "Done"
      - "Finished"
    error_markers:
      - "Error:"
      - "Failed:"
      - "Exception:"

  # Production Monitoring (v1.8.0)
  production_logging:
    # Master enable/disable
    enabled: true  # Enabled by default for production observability

    # Log file location
    path: "~/obra-runtime/logs/production.jsonl"

    # What to log
    events:
      user_input: true
      nl_results: true
      execution_results: true
      errors: true
      orchestrator_prompts: false    # Verbose, disabled by default
      implementer_responses: false   # Verbose, disabled by default

    # Privacy settings
    privacy:
      redact_pii: true               # Email, IP, phone, SSN
      redact_secrets: true           # API keys, tokens
      redact_patterns: []            # Custom regex patterns (future)

    # Log rotation
    rotation:
      max_file_size_mb: 100          # Rotate at 100MB
      max_files: 10                  # Keep 10 files (1GB total)

    # Performance (future)
    async_logging: false             # Sync by default
    buffer_size: 1024                # Flush every 1KB

# Orchestration Settings
orchestration:
  max_iterations: 50  # Maximum iterations per task
  iteration_timeout: 300  # Timeout per iteration (seconds)
  task_timeout: 3600  # Overall task timeout (seconds)
  concurrent_tasks: 1  # Number of tasks to run in parallel
  auto_retry: true  # Automatically retry failed operations

  # Maximum turns configuration for iterative orchestration
  max_turns:
    # Enable adaptive calculation based on task complexity
    adaptive: true

    # Fallback value if adaptive calculation fails
    # UPDATED (v1.8.1): Increased from 10 to 50 for complex stories
    default: 50

    # Task-type specific overrides (takes precedence over adaptive)
    by_task_type:
      validation: 5
      code_generation: 12
      refactoring: 15
      debugging: 20
      error_analysis: 8
      planning: 5
      documentation: 3
      testing: 8

    # NEW (v1.8.1): Obra task type specific limits
    # These map to TaskType enum (TASK, STORY, EPIC, SUBTASK)
    by_obra_task_type:
      TASK: 30        # Simple technical tasks
      STORY: 50       # User stories (default)
      EPIC: 100       # Large epics (batch execution)
      SUBTASK: 20     # Granular subtasks

    # Safety bounds - never exceed these limits
    # UPDATED (v1.8.1): Increased max from 30 to 150 to allow retry_multiplier headroom
    min: 3     # Never less than 3 turns (minimum for meaningful iteration)
    max: 150   # Never more than 150 turns (prevent infinite loops)

    # Retry behavior when error_max_turns is hit
    # UPDATED (v1.8.1): Increased multiplier from 2 to 3 for better retry capacity
    auto_retry: true         # Automatically retry with increased limit
    max_retries: 1           # Number of retries allowed (1 = try twice total)
    retry_multiplier: 3      # Multiply max_turns by this on retry (e.g., 50 -> 150)

# Breakpoint Configuration
breakpoints:
  enabled: true  # Enable breakpoint system
  auto_resolve_timeout: 300  # Auto-resolve timeout (seconds, 0 = wait forever)

  # When to trigger breakpoints
  triggers:
    low_confidence:
      enabled: true
      threshold: 30  # Confidence below this triggers breakpoint
    quality_too_low:
      enabled: true
      threshold: 50  # Quality score below this triggers breakpoint
    validation_failed:
      enabled: true
      max_retries: 3  # Trigger after this many validation failures
    rate_limit_hit:
      enabled: true
    unexpected_error:
      enabled: true

# Validation Settings
validation:
  response:
    check_completeness: true
    check_code_blocks_closed: true
    min_length: 10  # Minimum response length (characters)

  quality:
    enabled: true
    threshold: 70  # Minimum acceptable quality score (0-100)
    run_tests: true  # Execute tests if applicable
    check_syntax: true  # Validate code syntax

# Confidence Scoring
confidence:
  threshold: 50  # Minimum confidence to proceed without breakpoint
  weights:
    validation: 0.3  # Weight for validation result
    quality: 0.4  # Weight for quality score
    agent_health: 0.1  # Weight for agent health status
    retry_count: 0.2  # Weight for number of retries

# Decision Engine Configuration (SIMPLIFIED - Nov 2025)
# Controls when to proceed/clarify/escalate based on LLM quality scores
decision_engine:
  # NEW SIMPLIFIED THRESHOLDS (in use)
  # Decision logic now trusts LLM quality scores directly
  quality_proceed_threshold: 0.70    # Proceed if quality >= this AND validation passes
  quality_critical_threshold: 0.50   # Escalate if quality < this OR validation fails
  # Note: CLARIFY range is 0.50-0.70 (marginal quality)

  # DEPRECATED THRESHOLDS (kept for backward compatibility, not used)
  # These were part of the old heuristic-based system that caused clarification loops
  high_confidence: 0.45     # DEPRECATED: Was for heuristic overall_confidence
  medium_confidence: 0.30   # DEPRECATED: Was for heuristic confidence ranges
  critical_threshold: 0.20  # DEPRECATED: Was for heuristic escalation

  # DEPRECATED WEIGHTS (kept for backward compatibility, not used)
  # Decision logic no longer uses weighted multi-criteria scoring
  weight_confidence: 0.30   # DEPRECATED: Was for heuristic confidence
  weight_validation: 0.30   # DEPRECATED: Now validation is binary gate
  weight_quality: 0.30      # DEPRECATED: Now quality is primary signal
  weight_complexity: 0.05   # DEPRECATED: Complexity not used in decisions
  weight_history: 0.05      # DEPRECATED: History not used in decisions

# Context Management
context:
  max_tokens: 8000  # Maximum context tokens to include in prompts
  prioritization:
    - recent_interactions  # Most recent interactions (highest priority)
    - task_description  # Current task description
    - relevant_files  # Files mentioned in task
    - project_context  # General project context

  summarization:
    enabled: true  # Summarize old context when limit reached
    keep_recent: 5  # Keep this many recent interactions unsummarized

# Logging
logging:
  level: INFO  # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file: /home/omarwsl/obra-runtime/logs/orchestrator.log  # Log file path
  max_bytes: 10485760  # Max log file size (10MB)
  backup_count: 5  # Number of backup files to keep

# Prompt Templates
prompts:
  template_dir: config/prompt_templates  # Directory for Jinja2 templates

# Performance
performance:
  enable_caching: true  # Enable caching where applicable
  cache_ttl: 300  # Cache time-to-live (seconds)

# Development/Debug Settings (disable in production)
debug:
  enabled: false  # Enable debug mode
  save_interactions: true  # Save all interactions for debugging
  verbose_logging: false  # Extra verbose logging
